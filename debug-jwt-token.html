<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT Token Debugger - Astegni</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">JWT Token Debugger</h1>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Current Token Analysis</h2>
            <button onclick="debugToken()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 mb-4">
                Analyze Current Token
            </button>
            <pre id="output" class="bg-gray-100 p-4 rounded-lg overflow-auto max-h-96 text-sm"></pre>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Test API Call</h2>
            <button onclick="testBrandsAPI()" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 mb-4">
                Test /api/advertiser/brands
            </button>
            <pre id="apiOutput" class="bg-gray-100 p-4 rounded-lg overflow-auto max-h-96 text-sm"></pre>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Database Check</h2>
            <button onclick="checkDatabase()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 mb-4">
                Check Database State
            </button>
            <pre id="dbOutput" class="bg-gray-100 p-4 rounded-lg overflow-auto max-h-96 text-sm"></pre>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return { error: e.message };
            }
        }

        async function debugToken() {
            const output = document.getElementById('output');
            let debug = '=== JWT TOKEN DEBUG ===\n\n';

            // Get token from localStorage
            const token = localStorage.getItem('token');
            const access_token = localStorage.getItem('access_token');

            debug += '1. TOKENS IN LOCALSTORAGE:\n';
            debug += `   token: ${token ? 'EXISTS' : 'NOT FOUND'}\n`;
            debug += `   access_token: ${access_token ? 'EXISTS' : 'NOT FOUND'}\n`;
            debug += `   Same?: ${token === access_token}\n\n`;

            if (!token) {
                debug += '❌ ERROR: No token found in localStorage!\n';
                debug += '   Please log in again.\n';
                output.textContent = debug;
                return;
            }

            // Parse the token
            debug += '2. TOKEN STRUCTURE:\n';
            const parts = token.split('.');
            debug += `   Header: ${parts[0] ? 'Present' : 'Missing'}\n`;
            debug += `   Payload: ${parts[1] ? 'Present' : 'Missing'}\n`;
            debug += `   Signature: ${parts[2] ? 'Present' : 'Missing'}\n\n`;

            // Decode payload
            debug += '3. DECODED PAYLOAD:\n';
            const payload = parseJwt(token);
            debug += JSON.stringify(payload, null, 2) + '\n\n';

            // Check specific fields
            debug += '4. CRITICAL FIELDS:\n';
            debug += `   User ID (sub): ${payload.sub || 'MISSING'}\n`;
            debug += `   Active Role (role): ${payload.role || 'MISSING'}\n`;
            debug += `   role_ids: ${payload.role_ids ? JSON.stringify(payload.role_ids) : 'MISSING'}\n\n`;

            // Check advertiser role
            debug += '5. ADVERTISER ROLE CHECK:\n';
            if (payload.role_ids && payload.role_ids.advertiser) {
                debug += `   ✅ Advertiser role_id found: ${payload.role_ids.advertiser}\n`;
            } else {
                debug += `   ❌ Advertiser role_id NOT FOUND in token!\n`;
                debug += `   This is why you're getting 404 errors.\n\n`;
                debug += '   SOLUTION:\n';
                debug += '   1. Check if advertiser profile exists in database\n';
                debug += '   2. If it exists, the login process is not fetching it\n';
                debug += '   3. Try logging out completely (clear localStorage) and log back in\n';
            }

            // Check expiry
            debug += '\n6. TOKEN EXPIRY:\n';
            if (payload.exp) {
                const expDate = new Date(payload.exp * 1000);
                const now = new Date();
                const isExpired = now > expDate;
                debug += `   Expires: ${expDate.toLocaleString()}\n`;
                debug += `   Status: ${isExpired ? '❌ EXPIRED' : '✅ Valid'}\n`;
                debug += `   Time remaining: ${isExpired ? 'EXPIRED' : Math.round((expDate - now) / 1000 / 60) + ' minutes'}\n`;
            } else {
                debug += `   ❌ No expiry found in token\n`;
            }

            output.textContent = debug;
        }

        async function testBrandsAPI() {
            const output = document.getElementById('apiOutput');
            let debug = '=== API TEST: /api/advertiser/brands ===\n\n';

            const token = localStorage.getItem('token');
            if (!token) {
                debug += '❌ No token found!\n';
                output.textContent = debug;
                return;
            }

            debug += '1. REQUEST DETAILS:\n';
            debug += `   URL: ${API_BASE_URL}/api/advertiser/brands\n`;
            debug += `   Method: GET\n`;
            debug += `   Token: ${token.substring(0, 50)}...\n\n`;

            try {
                debug += '2. SENDING REQUEST...\n';
                const response = await fetch(`${API_BASE_URL}/api/advertiser/brands`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                debug += `   Status: ${response.status} ${response.statusText}\n\n`;

                debug += '3. RESPONSE:\n';
                const data = await response.json();
                debug += JSON.stringify(data, null, 2) + '\n\n';

                if (response.status === 404) {
                    debug += '4. ERROR ANALYSIS:\n';
                    debug += '   ❌ 404 Not Found - Endpoint exists but advertiser profile not found\n';
                    debug += '   This means your JWT token does NOT have advertiser role_id\n';
                    debug += '   or the advertiser profile does not exist in the database.\n\n';
                    debug += '   Run "Check Database State" below to verify.\n';
                } else if (response.ok) {
                    debug += '4. SUCCESS:\n';
                    debug += `   ✅ API call successful!\n`;
                    debug += `   Brands found: ${data.brands ? data.brands.length : 0}\n`;
                }

            } catch (error) {
                debug += `   ❌ ERROR: ${error.message}\n`;
            }

            output.textContent = debug;
        }

        async function checkDatabase() {
            const output = document.getElementById('dbOutput');
            let debug = '=== DATABASE CHECK ===\n\n';

            const token = localStorage.getItem('token');
            if (!token) {
                debug += '❌ No token found!\n';
                output.textContent = debug;
                return;
            }

            // Parse token to get user_id
            const payload = parseJwt(token);
            const userId = payload.sub;

            debug += `1. USER INFO FROM TOKEN:\n`;
            debug += `   User ID: ${userId}\n`;
            debug += `   Role IDs in token: ${JSON.stringify(payload.role_ids || {})}\n\n`;

            // Get user info from API
            try {
                debug += '2. FETCHING USER INFO FROM API...\n';
                const userResponse = await fetch(`${API_BASE_URL}/api/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    debug += `   ✅ User found\n`;
                    debug += `   Email: ${userData.email}\n`;
                    debug += `   Roles: ${JSON.stringify(userData.roles)}\n`;
                    debug += `   Active Role: ${userData.active_role}\n\n`;

                    // Check if advertiser is in roles
                    if (userData.roles && userData.roles.includes('advertiser')) {
                        debug += '3. ADVERTISER ROLE:\n';
                        debug += `   ✅ 'advertiser' role found in user.roles array\n\n`;

                        // Check if role_id exists in token
                        if (payload.role_ids && payload.role_ids.advertiser) {
                            debug += '4. DIAGNOSIS:\n';
                            debug += `   ✅ Advertiser profile exists in database (ID: ${payload.role_ids.advertiser})\n`;
                            debug += `   ✅ JWT token has advertiser role_id\n`;
                            debug += `   ✅ Everything looks correct!\n\n`;
                            debug += '   If you\'re still getting 404, check:\n';
                            debug += '   - Is the backend server running?\n';
                            debug += '   - Is the advertiser_brands_endpoints.py router registered in app.py?\n';
                        } else {
                            debug += '4. DIAGNOSIS:\n';
                            debug += `   ❌ JWT token does NOT have advertiser role_id\n`;
                            debug += `   ✅ But user.roles has 'advertiser'\n\n`;
                            debug += '   PROBLEM: Token was created BEFORE advertiser profile existed!\n\n';
                            debug += '   SOLUTION:\n';
                            debug += '   1. Clear localStorage completely:\n';
                            debug += '      localStorage.clear();\n';
                            debug += '   2. Log out completely\n';
                            debug += '   3. Close browser tab\n';
                            debug += '   4. Reopen and log back in\n';
                        }
                    } else {
                        debug += '3. ADVERTISER ROLE:\n';
                        debug += `   ❌ 'advertiser' role NOT found in user.roles array\n`;
                        debug += `   Database needs to be updated.\n`;
                    }
                } else {
                    debug += `   ❌ Failed to fetch user: ${userResponse.status}\n`;
                }

            } catch (error) {
                debug += `   ❌ ERROR: ${error.message}\n`;
            }

            output.textContent = debug;
        }

        // Auto-run on page load
        window.addEventListener('DOMContentLoaded', () => {
            debugToken();
        });
    </script>
</body>
</html>
