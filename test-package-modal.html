<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Package Modal - Astegni v2.2</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Root CSS -->
    <link rel="stylesheet" href="css/root.css">
    <link rel="stylesheet" href="css/root/theme.css">

    <!-- Package Modal CSS -->
    <link rel="stylesheet" href="css/tutor-profile/package-modal-enhanced.css">
    <link rel="stylesheet" href="css/tutor-profile/package-modal-clean.css">
    <link rel="stylesheet" href="css/tutor-profile/package-modal-fix.css">
    <link rel="stylesheet" href="css/tutor-profile/package-modal-responsive.css">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 50px;
            background: #f3f4f6;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            margin-bottom: 30px;
            color: #1f2937;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: #4b5563;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            background: #f0fdf4;
            border-left: 4px solid #10b981;
            border-radius: 4px;
            display: none;
        }
        .status.show {
            display: block;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }
        .test-btn {
            padding: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .test-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .test-btn i {
            font-size: 20px;
            color: #3b82f6;
        }
        #debugConsole {
            margin-top: 20px;
            padding: 15px;
            background: #1f2937;
            color: #10b981;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        #debugConsole.show {
            display: block;
        }
        .debug-line {
            margin: 2px 0;
        }
        .debug-error {
            color: #ef4444;
        }
        .debug-success {
            color: #10b981;
        }
        .debug-info {
            color: #60a5fa;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1><i class="fas fa-vial"></i> Package Modal Test Page v2.2</h1>
        <p style="margin-bottom: 20px; color: #6b7280;">
            Comprehensive testing for the package management modal with market trends and session format filters.
        </p>

        <div class="test-grid">
            <button class="test-btn" onclick="testOpenModal()">
                <i class="fas fa-box-open"></i>
                <span>Open Modal</span>
            </button>
            <button class="test-btn" onclick="testCreatePackage()">
                <i class="fas fa-plus"></i>
                <span>Create Test Package</span>
            </button>
            <button class="test-btn" onclick="testMarketTrends()">
                <i class="fas fa-chart-line"></i>
                <span>Test Market Trends</span>
            </button>
            <button class="test-btn" onclick="testCalculator()">
                <i class="fas fa-calculator"></i>
                <span>Test Calculator</span>
            </button>
            <button class="test-btn" onclick="checkStatus()">
                <i class="fas fa-info-circle"></i>
                <span>Check Status</span>
            </button>
            <button class="test-btn" onclick="toggleDebug()">
                <i class="fas fa-terminal"></i>
                <span>Toggle Debug Console</span>
            </button>
        </div>

        <div id="status" class="status">
            <strong>Success!</strong> Check the console and debug output below.
        </div>

        <div id="debugConsole"></div>

        <div style="margin-top: 40px; padding: 20px; background: #fef3c7; border-radius: 8px;">
            <h3 style="margin-top: 0; color: #92400e;"><i class="fas fa-info-circle"></i> Step-by-Step Instructions</h3>
            <ol style="color: #78350f; margin: 0; line-height: 1.8;">
                <li><strong>Open Modal:</strong> Click "Open Package Modal" button above</li>
                <li><strong>Add Courses:</strong> Type a course name (e.g., "Mathematics") and click the <i class="fas fa-plus"></i> button</li>
                <li><strong>Add More Courses:</strong> Repeat for multiple courses (e.g., "Physics", "Chemistry")</li>
                <li><strong>Set Pricing:</strong>
                    <ul style="margin: 5px 0;">
                        <li>Choose payment frequency (2 weeks or monthly)</li>
                        <li>Enter hourly rate in ETB (e.g., 150)</li>
                        <li>Add discounts for 3/6/12 months (optional)</li>
                    </ul>
                </li>
                <li><strong>Add More Packages:</strong> Click "Add Package" button at bottom to create additional packages</li>
                <li><strong>Save:</strong> Click "Save Packages" button</li>
                <li><strong>View Packages:</strong> Switch to "View Package" tab</li>
                <li><strong>Calculate Fees:</strong> Enter days/week and hours/day, then click "Calculate Fees"</li>
            </ol>
        </div>

        <div style="margin-top: 20px; padding: 20px; background: #dbeafe; border-radius: 8px;">
            <h3 style="margin-top: 0; color: #1e3a8a;"><i class="fas fa-lightbulb"></i> Expected Behavior</h3>
            <ul style="color: #1e40af; margin: 0; line-height: 1.8;">
                <li>✅ Courses should appear as blue tags when added</li>
                <li>✅ You can remove courses by clicking the × on each tag</li>
                <li>✅ You can remove entire packages by clicking the red × button</li>
                <li>✅ Pressing Enter in course input should add the course</li>
                <li>✅ ESC key should close the modal</li>
                <li>✅ All data persists in localStorage</li>
            </ul>
        </div>
    </div>

    <!-- Modal will be loaded here -->
    <div id="modalContainer"></div>

    <!-- Chart.js for market trends -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Config -->
    <script>
        const API_BASE_URL = window.API_BASE_URL || 'http://localhost:8000';
        window.API_BASE_URL = API_BASE_URL;

        // Debug logging function
        function debugLog(message, type = 'info') {
            const console = document.getElementById('debugConsole');
            const line = document.createElement('div');
            line.className = `debug-line debug-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;

            // Also log to browser console
            if (type === 'error') {
                window.console.error(message);
            } else if (type === 'success') {
                window.console.log(`✅ ${message}`);
            } else {
                window.console.log(message);
            }
        }

        // Load modal dynamically
        async function loadModal() {
            try {
                debugLog('Loading package-management-modal.html...', 'info');
                const response = await fetch('modals/tutor-profile/package-management-modal.html');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const html = await response.text();
                document.getElementById('modalContainer').innerHTML = html;
                debugLog('Modal loaded successfully', 'success');
            } catch (error) {
                debugLog(`Failed to load modal: ${error.message}`, 'error');
                alert('Failed to load modal. Check console for details.');
            }
        }

        // Load modal on page load
        window.addEventListener('DOMContentLoaded', () => {
            debugLog('Page loaded, initializing...', 'info');
            loadModal().then(() => {
                // Initialize package manager after a short delay
                setTimeout(() => {
                    if (typeof PackageManagerClean !== 'undefined') {
                        window.packageManager = new PackageManagerClean();
                        debugLog('PackageManagerClean initialized', 'success');
                    } else {
                        debugLog('PackageManagerClean not found', 'error');
                    }
                }, 500);
            });
        });
    </script>

    <!-- Package Manager Scripts (with cache busting) -->
    <script src="js/tutor-profile/package-manager-clean.js?v=2"></script>
    <script src="js/tutor-profile/market-trend-functions.js?v=2"></script>

    <!-- Test Functions -->
    <script>
        function testOpenModal() {
            debugLog('Opening package modal...', 'info');
            const modal = document.getElementById('package-management-modal');
            if (!modal) {
                debugLog('Modal element not found!', 'error');
                alert('Modal not loaded yet. Please wait and try again.');
                return;
            }
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            debugLog('Modal opened successfully', 'success');
            document.getElementById('status').classList.add('show');
        }

        function testCreatePackage() {
            debugLog('Testing package creation...', 'info');
            testOpenModal();
            setTimeout(() => {
                if (typeof createNewPackage === 'function') {
                    createNewPackage();
                    debugLog('Create new package function called', 'success');
                } else {
                    debugLog('createNewPackage function not found', 'error');
                }
            }, 500);
        }

        function testMarketTrends() {
            debugLog('Testing market trends...', 'info');
            testOpenModal();
            setTimeout(() => {
                if (typeof switchPackagePanel === 'function') {
                    switchPackagePanel('market-trend');
                    debugLog('Switched to market trends panel', 'success');
                } else {
                    debugLog('switchPackagePanel function not found', 'error');
                }
            }, 500);
        }

        function testCalculator() {
            debugLog('Testing calculator widget...', 'info');
            testOpenModal();
            setTimeout(() => {
                if (typeof toggleCalculatorWidget === 'function') {
                    toggleCalculatorWidget();
                    debugLog('Calculator widget toggled', 'success');
                } else {
                    debugLog('toggleCalculatorWidget function not found', 'error');
                }
            }, 500);
        }

        function checkStatus() {
            debugLog('Checking system status...', 'info');

            const packages = JSON.parse(localStorage.getItem('tutorPackages') || '[]');
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            const modal = document.getElementById('package-management-modal');

            debugLog(`Authentication: ${token ? 'Token found ✅' : 'No token ❌'}`, token ? 'success' : 'error');
            debugLog(`Packages in storage: ${packages.length}`, packages.length > 0 ? 'success' : 'info');
            debugLog(`Modal loaded: ${modal ? 'Yes ✅' : 'No ❌'}`, modal ? 'success' : 'error');
            debugLog(`PackageManager: ${typeof window.packageManager !== 'undefined' ? 'Loaded ✅' : 'Not loaded ❌'}`, typeof window.packageManager !== 'undefined' ? 'success' : 'error');
            debugLog(`API Base URL: ${API_BASE_URL}`, 'info');

            if (packages.length > 0) {
                packages.forEach((pkg, i) => {
                    debugLog(`  Package ${i + 1}: ${pkg.title || 'Untitled'} (${pkg.session_format || 'No format'})`, 'info');
                });
            }

            document.getElementById('status').classList.add('show');
        }

        function toggleDebug() {
            const console = document.getElementById('debugConsole');
            console.classList.toggle('show');
            if (console.classList.contains('show')) {
                debugLog('Debug console enabled', 'info');
            }
        }

        // Global function stubs for modal (if not loaded from package-manager-clean.js)
        window.closePackageModal = window.closePackageModal || function() {
            const modal = document.getElementById('package-management-modal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
                debugLog('Modal closed', 'info');
            }
        };

        window.togglePackageSidebar = window.togglePackageSidebar || function() {
            debugLog('togglePackageSidebar called', 'info');
        };

        window.switchPackagePanel = window.switchPackagePanel || function(panel) {
            debugLog(`switchPackagePanel called: ${panel}`, 'info');
        };

        window.createNewPackage = window.createNewPackage || function() {
            debugLog('createNewPackage called (stub)', 'info');
        };

        window.toggleCalculatorWidget = window.toggleCalculatorWidget || function() {
            debugLog('toggleCalculatorWidget called (stub)', 'info');
        };

        window.updateCalculator = window.updateCalculator || function() {
            debugLog('updateCalculator called', 'info');
        };

        window.saveCurrentPackage = window.saveCurrentPackage || function() {
            debugLog('saveCurrentPackage called', 'info');
        };

        window.changeGraphType = window.changeGraphType || function(type) {
            debugLog(`changeGraphType called: ${type}`, 'info');
        };

        window.updateMarketGraph = window.updateMarketGraph || function() {
            debugLog('updateMarketGraph called', 'info');
        };

        window.populateMarketTable = window.populateMarketTable || function() {
            debugLog('populateMarketTable called', 'info');
        };

        window.suggestMarketPrice = window.suggestMarketPrice || function() {
            debugLog('suggestMarketPrice called', 'info');
        };

        window.updateMarketTimePeriodOnly = window.updateMarketTimePeriodOnly || function(value) {
            debugLog(`updateMarketTimePeriodOnly called: ${value}`, 'info');
        };

        window.updatePriceTimePeriod = window.updatePriceTimePeriod || function(value) {
            debugLog(`updatePriceTimePeriod called: ${value}`, 'info');
        };

        window.toggleMarketDataset = window.toggleMarketDataset || function(checkbox) {
            debugLog(`toggleMarketDataset called: ${checkbox.checked}`, 'info');
        };

        window.updateGraphSessionFormat = window.updateGraphSessionFormat || function() {
            debugLog('updateGraphSessionFormat called', 'info');
        };

        // Log when scripts load
        debugLog('Test page scripts loaded', 'success');
    </script>
</body>
</html>
