<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role Reactivation Debug Tool</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #00ff00;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 10px;
        }
        .section {
            background: #2a2a2a;
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .section h2 {
            margin-top: 0;
            color: #00ccff;
        }
        pre {
            background: #000;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            color: #00ff00;
        }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
            font-weight: bold;
        }
        button:hover {
            background: #00cc00;
        }
        .error {
            color: #ff0000;
        }
        .warning {
            color: #ffaa00;
        }
        .success {
            color: #00ff00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Role Reactivation Debug Tool</h1>

        <div class="section">
            <h2>1. LocalStorage State</h2>
            <button onclick="checkLocalStorage()">Check LocalStorage</button>
            <button onclick="clearLocalStorage()">Clear LocalStorage</button>
            <pre id="localStorageOutput">Click "Check LocalStorage" to see current state...</pre>
        </div>

        <div class="section">
            <h2>2. SessionStorage State</h2>
            <button onclick="checkSessionStorage()">Check SessionStorage</button>
            <button onclick="clearSessionStorage()">Clear SessionStorage</button>
            <pre id="sessionStorageOutput">Click "Check SessionStorage" to see current state...</pre>
        </div>

        <div class="section">
            <h2>3. AuthManager State</h2>
            <button onclick="checkAuthManager()">Check AuthManager</button>
            <pre id="authManagerOutput">Click "Check AuthManager" to see current state...</pre>
        </div>

        <div class="section">
            <h2>4. Simulate Role Reactivation</h2>
            <p>This will simulate setting all the correct values for role reactivation:</p>
            <label>Role to simulate:
                <select id="roleSelect">
                    <option value="tutor">Tutor</option>
                    <option value="student">Student</option>
                    <option value="parent">Parent</option>
                    <option value="advertiser">Advertiser</option>
                </select>
            </label>
            <br><br>
            <button onclick="simulateReactivation()">Simulate Reactivation</button>
            <pre id="simulateOutput">Results will appear here...</pre>
        </div>

        <div class="section">
            <h2>5. Test Profile Page Access</h2>
            <button onclick="testProfileAccess('tutor')">Test Tutor Profile</button>
            <button onclick="testProfileAccess('student')">Test Student Profile</button>
            <button onclick="testProfileAccess('parent')">Test Parent Profile</button>
            <pre id="testOutput">Click a button to test profile page access...</pre>
        </div>
    </div>

    <script>
        function checkLocalStorage() {
            const output = document.getElementById('localStorageOutput');
            const data = {
                token: localStorage.getItem('token') ? '‚úì Present (length: ' + localStorage.getItem('token').length + ')' : '‚úó Missing',
                access_token: localStorage.getItem('access_token') ? '‚úì Present' : '‚úó Missing',
                userRole: localStorage.getItem('userRole') || '‚úó Missing',
                currentUser: localStorage.getItem('currentUser') ? JSON.parse(localStorage.getItem('currentUser')) : '‚úó Missing',
                user: localStorage.getItem('user') ? JSON.parse(localStorage.getItem('user')) : '‚úó Missing'
            };
            output.textContent = JSON.stringify(data, null, 2);
        }

        function checkSessionStorage() {
            const output = document.getElementById('sessionStorageOutput');
            const data = {
                role_switch_in_progress: sessionStorage.getItem('role_switch_in_progress') || '‚úó Not set',
                target_role: sessionStorage.getItem('target_role') || '‚úó Not set'
            };
            output.textContent = JSON.stringify(data, null, 2);
        }

        function checkAuthManager() {
            const output = document.getElementById('authManagerOutput');
            if (typeof window.AuthManager === 'undefined') {
                output.textContent = '‚úó AuthManager not loaded (this is expected on this debug page)';
                output.className = 'warning';
                return;
            }

            const data = {
                isAuthenticated: window.AuthManager.isAuthenticated(),
                user: window.AuthManager.getUser(),
                userRole: window.AuthManager.getUserRole(),
                token: window.AuthManager.token ? '‚úì Present' : '‚úó Missing'
            };
            output.textContent = JSON.stringify(data, null, 2);
        }

        function clearLocalStorage() {
            if (confirm('Clear ALL localStorage? This will log you out!')) {
                localStorage.clear();
                alert('LocalStorage cleared!');
                checkLocalStorage();
            }
        }

        function clearSessionStorage() {
            sessionStorage.clear();
            alert('SessionStorage cleared!');
            checkSessionStorage();
        }

        function simulateReactivation() {
            const role = document.getElementById('roleSelect').value;
            const output = document.getElementById('simulateOutput');

            // Simulate what should happen after role reactivation
            const fakeToken = 'fake_jwt_token_' + Date.now();
            const fakeUser = {
                id: 123,
                role: role,
                active_role: role,
                roles: ['student', 'tutor', 'parent']
            };

            // Update localStorage (simulating profile-system.js)
            localStorage.setItem('token', fakeToken);
            localStorage.setItem('access_token', fakeToken);
            localStorage.setItem('userRole', role);
            localStorage.setItem('currentUser', JSON.stringify(fakeUser));

            // Update sessionStorage
            sessionStorage.setItem('role_switch_in_progress', 'true');
            sessionStorage.setItem('target_role', role);

            output.innerHTML = `<span class="success">‚úì Simulated ${role} reactivation!</span>\n\n`;
            output.innerHTML += 'Set values:\n';
            output.innerHTML += `  - localStorage.userRole = "${role}"\n`;
            output.innerHTML += `  - localStorage.currentUser.active_role = "${role}"\n`;
            output.innerHTML += `  - sessionStorage.role_switch_in_progress = "true"\n`;
            output.innerHTML += `  - sessionStorage.target_role = "${role}"\n\n`;
            output.innerHTML += 'Now try accessing the profile page for this role!';
        }

        function testProfileAccess(role) {
            const output = document.getElementById('testOutput');

            // Check current state
            const userRole = localStorage.getItem('userRole');
            const currentUser = localStorage.getItem('currentUser') ? JSON.parse(localStorage.getItem('currentUser')) : null;
            const switchInProgress = sessionStorage.getItem('role_switch_in_progress');
            const targetRole = sessionStorage.getItem('target_role');

            output.innerHTML = `Testing access to ${role} profile page...\n\n`;
            output.innerHTML += `Current State:\n`;
            output.innerHTML += `  - localStorage.userRole: "${userRole}"\n`;
            output.innerHTML += `  - currentUser.active_role: "${currentUser?.active_role}"\n`;
            output.innerHTML += `  - sessionStorage.role_switch_in_progress: "${switchInProgress}"\n`;
            output.innerHTML += `  - sessionStorage.target_role: "${targetRole}"\n\n`;

            // Determine if access would be granted
            const hasSessionFlag = switchInProgress === 'true' && targetRole === role;
            const hasCorrectRole = userRole === role || currentUser?.active_role === role;

            if (hasSessionFlag) {
                output.innerHTML += `<span class="success">‚úì WOULD ALLOW ACCESS (sessionStorage flag set)</span>\n`;
                output.innerHTML += `  - Role switch in progress to ${role}\n`;
                output.innerHTML += `  - Would skip role validation\n`;
            } else if (hasCorrectRole) {
                output.innerHTML += `<span class="success">‚úì WOULD ALLOW ACCESS (correct role)</span>\n`;
                output.innerHTML += `  - User has ${role} role active\n`;
            } else {
                output.innerHTML += `<span class="error">‚úó WOULD DENY ACCESS</span>\n`;
                output.innerHTML += `  - No sessionStorage flag\n`;
                output.innerHTML += `  - Role mismatch (need ${role}, have ${userRole || currentUser?.active_role || 'none'})\n`;
            }

            output.innerHTML += `\n<button onclick="window.location.href='profile-pages/${role}-profile.html'">Go to ${role} profile</button>`;
        }

        // Auto-check on load
        window.addEventListener('DOMContentLoaded', () => {
            checkLocalStorage();
            checkSessionStorage();
            checkAuthManager();
        });
    </script>
</body>
</html>
