<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .notification-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background-color: gray;
            border-radius: 50%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>');
            background-size: 80%;
            background-position: center;
            background-repeat: no-repeat;
            margin-left: 8px;
        }
        .notification-icon.active {
            background-color: red;
        }
        .live-search-results {
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ccc;
            position: absolute;
            width: 100%;
            z-index: 100;
        }
        .sidebar {
            width: 250px;
            background-color: #f7fafc;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #e2e8f0;
        }
        .content-area {
            flex-grow: 1;
            padding: 20px;
        }
        .question-mark {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold mb-4">Quiz System</h1>
        <div class="flex space-x-4 mb-4">
            <button id="giveQuizBtn" class="bg-blue-500 text-white px-4 py-2 rounded">Give a Quiz</button>
            <div class="relative">
                <button id="myQuizzesBtn" class="bg-green-500 text-white px-4 py-2 rounded flex items-center">
                    My Quizzes
                    <span id="myQuizzesNotification" class="notification-icon"></span>
                </button>
            </div>
            <div class="relative">
                <button id="viewAnswersBtn" class="bg-purple-500 text-white px-4 py-2 rounded flex items-center">
                    View Answers
                    <span id="viewAnswersNotification" class="notification-icon"></span>
                </button>
            </div>
        </div>

        <!-- Tutor: Give a Quiz Modal -->
        <div id="giveQuizModal" class="modal">
            <div class="modal-content w-full max-w-2xl">
                <h2 class="text-2xl font-bold mb-4">Create a Quiz</h2>
                <div class="mb-4">
                    <label class="block">Student Name:</label>
                    <input type="text" id="studentSearch" class="border p-2 w-full" placeholder="Search students...">
                    <div id="studentSearchResults" class="live-search-results hidden"></div>
                    <div id="selectedStudent" class="mt-2"></div>
                </div>
                <div class="mb-4">
                    <label class="block">Course Name:</label>
                    <input type="text" id="courseName" class="border p-2 w-full" placeholder="Enter course name">
                </div>
                <div class="mb-4">
                    <label class="block">Quiz Type:</label>
                    <input type="text" id="quizType" class="border p-2 w-full" placeholder="Enter quiz type (e.g., Practice, Graded)">
                </div>
                <div class="mb-4">
                    <label class="block">Time to Finish (minutes):</label>
                    <input type="number" id="quizTime" class="border p-2 w-full" value="20">
                </div>
                <div class="mb-4">
                    <label class="block">Days to Complete:</label>
                    <input type="number" id="quizDays" class="border p-2 w-full" placeholder="Enter days (e.g., 2, 7)" min="1">
                </div>
                <div id="questionsContainer" class="mb-4"></div>
                <button id="addQuestionBtn" class="bg-blue-500 text-white px-4 py-2 rounded mb-4">Add Question</button>
                <div class="flex space-x-4">
                    <button id="saveQuizBtn" class="bg-green-500 text-white px-4 py-2 rounded">Save Quiz</button>
                    <button id="postQuizBtn" class="bg-purple-500 text-white px-4 py-2 rounded">Post Quiz</button>
                    <button id="closeQuizModalBtn" class="bg-red-500 text-white px-4 py-2 rounded">Close</button>
                </div>
            </div>
        </div>

        <!-- Student: My Quizzes Modal -->
        <div id="myQuizzesModal" class="modal">
            <div class="modal-content w-full max-w-4xl">
                <div class="flex">
                    <div class="sidebar">
                        <h3 class="text-xl font-bold mb-4">Tutors</h3>
                        <input type="text" id="tutorSearch" class="border p-2 w-full mb-4" placeholder="Search tutors...">
                        <div id="tutorSearchResults" class="live-search-results hidden mb-4"></div>
                        <div id="tutorList"></div>
                    </div>
                    <div class="content-area">
                        <h2 class="text-2xl font-bold mb-4">My Quizzes</h2>
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="border p-2">Course Name</th>
                                    <th class="border p-2">Quiz Type</th>
                                    <th class="border p-2">Score</th>
                                    <th class="border p-2">Time Given</th>
                                    <th class="border p-2">Due Date</th>
                                    <th class="border p-2">Action</th>
                                </tr>
                            </thead>
                            <tbody id="quizTableBody"></tbody>
                        </table>
                        <button id="closeMyQuizzesModalBtn" class="bg-red-500 text-white px-4 py-2 rounded mt-4">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tutor: View Answers Modal -->
        <div id="viewAnswersModal" class="modal">
            <div class="modal-content w-full max-w-4xl">
                <div class="flex">
                    <div class="sidebar">
                        <h3 class="text-xl font-bold mb-4">Students</h3>
                        <input type="text" id="studentAnswerSearch" class="border p-2 w-full mb-4" placeholder="Search students...">
                        <div id="studentAnswerSearchResults" class="live-search-results hidden mb-4"></div>
                        <div id="studentList"></div>
                    </div>
                    <div class="content-area">
                        <h2 class="text-2xl font-bold mb-4">Student Answers</h2>
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-200">
                                    <th class="border p-2">Course Name</th>
                                    <th class="border p-2">Quiz Type</th>
                                    <th class="border p-2">Action</th>
                                </tr>
                            </thead>
                            <tbody id="answerTableBody"></tbody>
                        </table>
                        <button id="closeViewAnswersModalBtn" class="bg-red-500 text-white px-4 py-2 rounded mt-4">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tutor: View Individual Answer Modal -->
        <div id="viewIndividualAnswerModal" class="modal">
            <div class="modal-content w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-4">Student Answers</h2>
                <div id="answerDetails"></div>
                <div class="flex space-x-4 mt-4">
                    <button id="submitScoreBtn" class="bg-green-500 text-white px-4 py-2 rounded">Submit Score</button>
                    <button id="closeIndividualAnswerModalBtn" class="bg-red-500 text-white px-4 py-2 rounded">Close</button>
                </div>
            </div>
        </div>

        <!-- Student: View Quiz Modal -->
        <div id="viewQuizModal" class="modal">
            <div class="modal-content w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-4">Quiz Warning</h2>
                <div id="quizWarningContent"></div>
                <div id="quizWarningButtons" class="flex space-x-4 mt-4"></div>
            </div>
        </div>

        <!-- Student: Take Quiz Modal -->
        <div id="takeQuizModal" class="modal">
            <div class="modal-content w-full max-w-lg">
                <div class="flex justify-between mb-4">
                    <h2 class="text-2xl font-bold">Taking Quiz</h2>
                    <div>
                        <span id="timerDisplay" class="mr-4"></span>
                        <span id="questionsLeft"></span>
                    </div>
                </div>
                <div id="currentQuestion"></div>
                <div class="flex space-x-4 mt-4">
                    <button id="prevQuestionBtn" class="bg-gray-500 text-white px-4 py-2 rounded">Previous</button>
                    <button id="nextQuestionBtn" class="bg-blue-500 text-white px-4 py-2 rounded">Next</button>
                    <button id="submitQuizBtn" class="bg-green-500 text-white px-4 py-2 rounded">Submit</button>
                    <button id="cancelQuizBtn" class="bg-red-500 text-white px-4 py-2 rounded">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Submit Confirmation Modal -->
        <div id="submitQuizModal" class="modal">
            <div class="modal-content w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Confirm Submission</h2>
                <p class="mb-4">Are you sure you want to submit the quiz?</p>
                <button id="confirmSubmitBtn" class="bg-green-500 text-white px-4 py-2 rounded">Submit</button>
                <button id="cancelSubmitBtn" class="bg-red-500 text-white px-4 py-2 rounded ml-4">Cancel</button>
            </div>
        </div>

        <!-- Student: View Score Modal -->
        <div id="viewScoreModal" class="modal">
            <div class="modal-content w-full max-w-lg">
                <h2 class="text-2xl font-bold mb-4">Quiz Score</h2>
                <div id="scoreDetails"></div>
                <button id="closeViewScoreModalBtn" class="bg-red-500 text-white px-4 py-2 rounded mt-4">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Sample data
        const students = [
            { id: 1, name: "Alice Smith", profilePic: "https://via.placeholder.com/40" },
            { id: 2, name: "Bob Johnson", profilePic: "https://via.placeholder.com/40" }
        ];
        const tutors = [
            { id: 1, name: "Dr. Lee", profilePic: "https://via.placeholder.com/40" },
            { id: 2, name: "Prof. Kim", profilePic: "https://via.placeholder.com/40" }
        ];
        let quizzes = [];
        let currentQuiz = null;
        let currentQuestionIndex = 0;
        let studentAnswers = [];
        let timerInterval;
        let selectedTutorId = null;
        let selectedStudentId = null;
        let savedQuizProgress = {};

        // Generate UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Tutor: Give a Quiz
        document.getElementById('giveQuizBtn').addEventListener('click', () => {
            document.getElementById('giveQuizModal').style.display = 'flex';
            document.getElementById('studentSearch').focus();
        });

        // Student Search for Quiz Creation
        document.getElementById('studentSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const resultsDiv = document.getElementById('studentSearchResults');
            resultsDiv.innerHTML = '';
            if (query) {
                resultsDiv.classList.remove('hidden');
                const filtered = students.filter(s => s.name.toLowerCase().includes(query));
                filtered.forEach(student => {
                    const div = document.createElement('div');
                    div.className = 'p-2 hover:bg-gray-200 cursor-pointer flex items-center';
                    div.innerHTML = `<img src="${student.profilePic}" class="profile-pic mr-2"> ${student.name}`;
                    div.addEventListener('click', () => {
                        document.getElementById('selectedStudent').innerHTML = 
                            `<div class="flex items-center"><img src="${student.profilePic}" class="profile-pic mr-2"> ${student.name}</div>`;
                        document.getElementById('selectedStudent').dataset.studentId = student.id;
                        resultsDiv.classList.add('hidden');
                        document.getElementById('studentSearch').value = '';
                    });
                    resultsDiv.appendChild(div);
                });
            } else {
                resultsDiv.classList.add('hidden');
            }
        });

        // Add Question
        document.getElementById('addQuestionBtn').addEventListener('click', () => {
            const container = document.getElementById('questionsContainer');
            const questionId = generateUUID();
            const questionDiv = document.createElement('div');
            questionDiv.className = 'border p-4 mb-4';
            questionDiv.id = `question-${questionId}`;
            questionDiv.innerHTML = `
                <label class="block">Question:</label>
                <input type="text" class="question-text border p-2 w-full mb-2" placeholder="Enter question">
                <label class="block">Question Type:</label>
                <select class="question-type border p-2 w-full mb-2">
                    <option value="trueFalse">True/False</option>
                    <option value="multipleChoice">Multiple Choice</option>
                    <option value="open">Open</option>
                </select>
                <div class="choices-container"></div>
                <button class="remove-question bg-red-500 text-white px-2 py-1 rounded mt-2">Remove</button>
            `;
            container.appendChild(questionDiv);
            updateQuestionType(questionDiv);
            questionDiv.querySelector('.question-type').addEventListener('change', () => updateQuestionType(questionDiv));
            questionDiv.querySelector('.remove-question').addEventListener('click', () => questionDiv.remove());
        });

        function updateQuestionType(questionDiv) {
            const type = questionDiv.querySelector('.question-type').value;
            const choicesContainer = questionDiv.querySelector('.choices-container');
            choicesContainer.innerHTML = '';
            if (type === 'trueFalse') {
                choicesContainer.innerHTML = `
                    <label><input type="radio" name="correct-${questionDiv.id}" value="true" required> True</label>
                    <label><input type="radio" name="correct-${questionDiv.id}" value="false"> False</label>
                `;
            } else if (type === 'multipleChoice') {
                choicesContainer.innerHTML = `
                    <div class="choices"></div>
                    <button class="add-choice bg-blue-500 text-white px-2 py-1 rounded mt-2">Add Choice</button>
                `;
                // Add one choice by default
                const choiceId = generateUUID();
                const choiceDiv = document.createElement('div');
                choiceDiv.className = 'choice flex items-center mb-2';
                choiceDiv.innerHTML = `
                    <input type="checkbox" class="correct-choice mr-2" value="${choiceId}">
                    <input type="text" class="choice-text border p-2 flex-grow" placeholder="Enter choice">
                    <button class="remove-choice bg-red-500 text-white px-2 py-1 rounded ml-2">Remove</button>
                `;
                choicesContainer.querySelector('.choices').appendChild(choiceDiv);
                choiceDiv.querySelector('.remove-choice').addEventListener('click', () => choiceDiv.remove());
                choicesContainer.querySelector('.add-choice').addEventListener('click', () => {
                    const newChoiceId = generateUUID();
                    const newChoiceDiv = document.createElement('div');
                    newChoiceDiv.className = 'choice flex items-center mb-2';
                    newChoiceDiv.innerHTML = `
                        <input type="checkbox" class="correct-choice mr-2" value="${newChoiceId}">
                        <input type="text" class="choice-text border p-2 flex-grow" placeholder="Enter choice">
                        <button class="remove-choice bg-red-500 text-white px-2 py-1 rounded ml-2">Remove</button>
                    `;
                    choicesContainer.querySelector('.choices').appendChild(newChoiceDiv);
                    newChoiceDiv.querySelector('.remove-choice').addEventListener('click', () => newChoiceDiv.remove());
                });
            } else if (type === 'open') {
                choicesContainer.innerHTML = '<p>Open-ended question. Student answers will be manually graded.</p>';
            }
        }

        // Save Quiz
        document.getElementById('saveQuizBtn').addEventListener('click', () => {
            const quiz = collectQuizData();
            if (quiz) {
                localStorage.setItem('savedQuiz', JSON.stringify(quiz));
                alert('Quiz saved locally!');
            }
        });

        // Post Quiz
        document.getElementById('postQuizBtn').addEventListener('click', () => {
            const quiz = collectQuizData();
            if (quiz) {
                quizzes.push(quiz);
                updateNotifications();
                alert('Quiz posted!');
                document.getElementById('giveQuizModal').style.display = 'none';
                clearQuizForm();
            }
        });

        function collectQuizData() {
            const studentId = document.getElementById('selectedStudent').dataset.studentId;
            const courseName = document.getElementById('courseName').value;
            const quizType = document.getElementById('quizType').value;
            const quizTime = parseInt(document.getElementById('quizTime').value);
            const quizDays = parseInt(document.getElementById('quizDays').value);
            if (!studentId || !courseName || !quizType || !quizTime || !quizDays) {
                alert('Please fill all fields');
                return null;
            }
            const questions = [];
            document.querySelectorAll('#questionsContainer > div').forEach(div => {
                const questionText = div.querySelector('.question-text').value;
                const questionType = div.querySelector('.question-type').value;
                let correctAnswers = [];
                if (questionType === 'trueFalse') {
                    const selected = div.querySelector(`input[name="correct-${div.id}"]:checked`);
                    if (selected) correctAnswers = [selected.value];
                } else if (questionType === 'multipleChoice') {
                    div.querySelectorAll('.correct-choice:checked').forEach(cb => {
                        const choiceText = cb.nextElementSibling.value;
                        if (choiceText) correctAnswers.push(choiceText);
                    });
                }
                if (questionText && (questionType === 'open' || correctAnswers.length > 0)) {
                    const choices = questionType === 'trueFalse' ? ['true', 'false'] : 
                        questionType === 'multipleChoice' ? Array.from(div.querySelectorAll('.choice-text')).map(input => input.value).filter(v => v) : [];
                    questions.push({ id: div.id, text: questionText, type: questionType, choices, correctAnswers });
                }
            });
            if (questions.length === 0) {
                alert('Please add at least one question with correct answers (if applicable)');
                return null;
            }
            const postDate = new Date();
            const dueDate = new Date(postDate.getTime() + quizDays * 24 * 60 * 60 * 1000);
            return {
                id: generateUUID(),
                tutorId: 1, // Assume logged-in tutor
                studentId,
                courseName,
                quizType,
                quizTime,
                quizDays,
                dueDate: dueDate.toISOString(),
                postDate: postDate.toISOString(),
                questions,
                status: 'posted'
            };
        }

        function clearQuizForm() {
            document.getElementById('selectedStudent').innerHTML = '';
            document.getElementById('courseName').value = '';
            document.getElementById('quizType').value = '';
            document.getElementById('quizTime').value = '20';
            document.getElementById('quizDays').value = '';
            document.getElementById('questionsContainer').innerHTML = '';
        }

        // Close Give Quiz Modal
        document.getElementById('closeQuizModalBtn').addEventListener('click', () => {
            document.getElementById('giveQuizModal').style.display = 'none';
            clearQuizForm();
        });

        // Student: My Quizzes
        document.getElementById('myQuizzesBtn').addEventListener('click', () => {
            document.getElementById('myQuizzesModal').style.display = 'flex';
            if (tutors.length > 0 && !selectedTutorId) {
                selectedTutorId = tutors[0].id; // Auto-select first tutor
            }
            updateTutorList();
            updateQuizTable();
            document.getElementById('tutorSearch').focus();
        });

        // Tutor Search for My Quizzes
        document.getElementById('tutorSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const resultsDiv = document.getElementById('tutorSearchResults');
            resultsDiv.innerHTML = '';
            if (query) {
                resultsDiv.classList.remove('hidden');
                const filtered = tutors.filter(t => t.name.toLowerCase().includes(query));
                filtered.forEach(tutor => {
                    const div = document.createElement('div');
                    div.className = 'p-2 hover:bg-gray-200 cursor-pointer flex items-center';
                    div.innerHTML = `<img src="${tutor.profilePic}" class="profile-pic mr-2"> ${tutor.name}`;
                    div.addEventListener('click', () => {
                        selectedTutorId = tutor.id;
                        updateTutorList();
                        updateQuizTable();
                        resultsDiv.classList.add('hidden');
                        document.getElementById('tutorSearch').value = '';
                    });
                    resultsDiv.appendChild(div);
                });
            } else {
                resultsDiv.classList.add('hidden');
            }
        });

        function updateTutorList() {
            const tutorList = document.getElementById('tutorList');
            tutorList.innerHTML = '';
            const studentId = 1; // Assume logged-in student
            tutors.forEach(tutor => {
                const hasQuiz = quizzes.some(q => 
                    q.tutorId === tutor.id && 
                    q.studentId == studentId && 
                    q.status === 'posted' && 
                    new Date(q.dueDate) >= new Date()
                );
                const div = document.createElement('div');
                div.className = `p-2 flex items-center cursor-pointer ${selectedTutorId === tutor.id ? 'bg-blue-100' : 'hover:bg-gray-200'}`;
                div.innerHTML = `
                    <img src="${tutor.profilePic}" class="profile-pic mr-2">
                    ${tutor.name}
                    <span class="notification-icon ${hasQuiz ? 'active' : ''}"></span>
                `;
                div.addEventListener('click', () => {
                    selectedTutorId = tutor.id;
                    updateTutorList();
                    updateQuizTable();
                });
                tutorList.appendChild(div);
            });
        }

        function updateQuizTable() {
            const tbody = document.getElementById('quizTableBody');
            tbody.innerHTML = '';
            const studentId = 1; // Assume logged-in student
            const filteredQuizzes = quizzes.filter(q => 
                q.studentId == studentId && 
                (!selectedTutorId || q.tutorId == selectedTutorId) &&
                new Date(q.dueDate) >= new Date()
            );
            filteredQuizzes.forEach(quiz => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border p-2">${quiz.courseName}</td>
                    <td class="border p-2">${quiz.quizType}</td>
                    <td class="border p-2">${quiz.score || '-'}</td>
                    <td class="border p-2">${quiz.quizTime} min</td>
                    <td class="border p-2">${new Date(quiz.dueDate).toLocaleDateString()}</td>
                    <td class="border p-2">
                        ${quiz.score ? 
                            `<button class="view-score bg-blue-500 text-white px-2 py-1 rounded" data-quiz-id="${quiz.id}">View Score</button>` :
                            `<button class="view-quiz bg-blue-500 text-white px-2 py-1 rounded" data-quiz-id="${quiz.id}">View Quiz</button>`
                        }
                    </td>
                `;
                tbody.appendChild(row);
                if (quiz.score) {
                    row.querySelector('.view-score').addEventListener('click', () => {
                        currentQuiz = quizzes.find(q => q.id === quiz.id);
                        showScoreDetails();
                    });
                } else {
                    row.querySelector('.view-quiz').addEventListener('click', () => {
                        currentQuiz = quizzes.find(q => q.id === quiz.id);
                        showViewQuizModal();
                    });
                }
            });
            updateNotifications();
        }

        function updateNotifications() {
            const studentId = 1; // Assume logged-in student
            const tutorId = 1; // Assume logged-in tutor
            const hasPendingQuizzes = quizzes.some(q => 
                q.studentId == studentId && 
                q.status === 'posted' && 
                new Date(q.dueDate) >= new Date()
            );
            document.getElementById('myQuizzesNotification').classList.toggle('active', hasPendingQuizzes);
            
            const hasPendingAnswers = quizzes.some(q => 
                q.tutorId == tutorId && 
                q.studentAnswers && 
                !q.score
            );
            document.getElementById('viewAnswersNotification').classList.toggle('active', hasPendingAnswers);
        }

        function showViewQuizModal() {
            document.getElementById('myQuizzesModal').style.display = 'none';
            document.getElementById('viewQuizModal').style.display = 'flex';
            const contentDiv = document.getElementById('quizWarningContent');
            const buttonsDiv = document.getElementById('quizWarningButtons');
            if (currentQuiz.status === 'completed') {
                contentDiv.innerHTML = `<p class="mb-4">You have already taken this quiz.</p>`;
                buttonsDiv.innerHTML = `
                    <button id="closeViewQuizModalBtn" class="bg-red-500 text-white px-4 py-2 rounded">Close</button>
                `;
                document.getElementById('closeViewQuizModalBtn').addEventListener('click', closeViewQuizModal);
            } else {
                const hasProgress = savedQuizProgress[currentQuiz.id];
                contentDiv.innerHTML = `
                    <p class="mb-4">Only start when you're ready. If you feel you want to finish the quiz some other time after you start taking the quiz, don't worry just cancel. You'll resume when you're ready.</p>
                `;
                buttonsDiv.innerHTML = `
                    <button id="${hasProgress ? 'resumeQuizBtn' : 'startQuizBtn'}" class="bg-blue-500 text-white px-4 py-2 rounded">${hasProgress ? 'Resume Quiz' : 'Start Quiz'}</button>
                    <button id="closeViewQuizModalBtn" class="bg-red-500 text-white px-4 py-2 rounded ml-4">Close</button>
                `;
                document.getElementById(hasProgress ? 'resumeQuizBtn' : 'startQuizBtn').addEventListener('click', hasProgress ? resumeQuiz : startQuiz);
                document.getElementById('closeViewQuizModalBtn').addEventListener('click', closeViewQuizModal);
            }
        }

        function startQuiz() {
            document.getElementById('viewQuizModal').style.display = 'none';
            document.getElementById('takeQuizModal').style.display = 'flex';
            currentQuestionIndex = 0;
            studentAnswers = Array(currentQuiz.questions.length).fill(null);
            startTimer();
            showQuestion();
        }

        function resumeQuiz() {
            document.getElementById('viewQuizModal').style.display = 'none';
            document.getElementById('takeQuizModal').style.display = 'flex';
            const progress = savedQuizProgress[currentQuiz.id];
            currentQuestionIndex = progress.currentQuestionIndex;
            studentAnswers = progress.studentAnswers;
            startTimer();
            showQuestion();
        }

        function closeViewQuizModal() {
            document.getElementById('viewQuizModal').style.display = 'none';
            document.getElementById('myQuizzesModal').style.display = 'flex';
        }

        function showScoreDetails() {
            document.getElementById('myQuizzesModal').style.display = 'none';
            document.getElementById('viewScoreModal').style.display = 'flex';
            const scoreDetails = document.getElementById('scoreDetails');
            scoreDetails.innerHTML = '';
            const student = students.find(s => s.id == currentQuiz.studentId);
            scoreDetails.innerHTML += `<p><strong>Student:</strong> ${student.name}</p>`;
            scoreDetails.innerHTML += `<p><strong>Course:</strong> ${currentQuiz.courseName}</p>`;
            scoreDetails.innerHTML += `<p><strong>Quiz Type:</strong> ${currentQuiz.quizType}</p>`;
            scoreDetails.innerHTML += `<p><strong>Score:</strong> ${currentQuiz.score}</p>`;
            currentQuiz.questions.forEach((q, i) => {
                const answer = currentQuiz.studentAnswers[i] || 'No answer provided';
                const answerText = Array.isArray(answer) ? answer.join(', ') : answer;
                const mark = currentQuiz.marks ? currentQuiz.marks[i] : null;
                const explanation = currentQuiz.explanations ? currentQuiz.explanations[i] : '';
                scoreDetails.innerHTML += `
                    <div class="border p-2 mb-2 relative">
                        <p><strong>Question ${i + 1}:</strong> ${q.text}</p>
                        <p><strong>Answer:</strong> ${answerText}</p>
                        <p><strong>Status:</strong> ${mark ? (mark === 'correct' ? 'Correct ✅' : 'Incorrect ❌') : 'Not graded'}</p>
                        ${explanation && mark === 'wrong' ? `<p><strong>Explanation:</strong> ${explanation}</p>` : ''}
                    </div>
                `;
            });
        }

        document.getElementById('closeViewScoreModalBtn').addEventListener('click', () => {
            document.getElementById('viewScoreModal').style.display = 'none';
            document.getElementById('myQuizzesModal').style.display = 'flex';
        });

        // Close My Quizzes Modal
        document.getElementById('closeMyQuizzesModalBtn').addEventListener('click', () => {
            document.getElementById('myQuizzesModal').style.display = 'none';
            selectedTutorId = null;
        });

        // Tutor: View Answers
        document.getElementById('viewAnswersBtn').addEventListener('click', () => {
            document.getElementById('viewAnswersModal').style.display = 'flex';
            if (students.length > 0 && !selectedStudentId) {
                selectedStudentId = students[0].id; // Auto-select first student
            }
            updateStudentList();
            updateAnswerTable();
            document.getElementById('studentAnswerSearch').focus();
        });

        // Student Search for View Answers
        document.getElementById('studentAnswerSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const resultsDiv = document.getElementById('studentAnswerSearchResults');
            resultsDiv.innerHTML = '';
            if (query) {
                resultsDiv.classList.remove('hidden');
                const filtered = students.filter(s => s.name.toLowerCase().includes(query));
                filtered.forEach(student => {
                    const div = document.createElement('div');
                    div.className = 'p-2 hover:bg-gray-200 cursor-pointer flex items-center';
                    div.innerHTML = `<img src="${student.profilePic}" class="profile-pic mr-2"> ${student.name}`;
                    div.addEventListener('click', () => {
                        selectedStudentId = student.id;
                        updateStudentList();
                        updateAnswerTable();
                        resultsDiv.classList.add('hidden');
                        document.getElementById('studentAnswerSearch').value = '';
                    });
                    resultsDiv.appendChild(div);
                });
            } else {
                resultsDiv.classList.add('hidden');
            }
        });

        function updateStudentList() {
            const studentList = document.getElementById('studentList');
            studentList.innerHTML = '';
            const tutorId = 1; // Assume logged-in tutor
            students.forEach(student => {
                const hasAnswer = quizzes.some(q => 
                    q.studentId === student.id && 
                    q.tutorId == tutorId && 
                    q.studentAnswers && 
                    !q.score
                );
                const div = document.createElement('div');
                div.className = `p-2 flex items-center cursor-pointer ${selectedStudentId === student.id ? 'bg-blue-100' : 'hover:bg-gray-200'}`;
                div.innerHTML = `
                    <img src="${student.profilePic}" class="profile-pic mr-2">
                    ${student.name}
                    <span class="notification-icon ${hasAnswer ? 'active' : ''}"></span>
                `;
                div.addEventListener('click', () => {
                    selectedStudentId = student.id;
                    updateStudentList();
                    updateAnswerTable();
                });
                studentList.appendChild(div);
            });
        }

        function updateAnswerTable() {
            const tbody = document.getElementById('answerTableBody');
            tbody.innerHTML = '';
            const tutorId = 1; // Assume logged-in tutor
            const filteredQuizzes = quizzes.filter(q => 
                q.tutorId == tutorId && 
                (!selectedStudentId || q.studentId == selectedStudentId) && 
                q.studentAnswers && 
                !q.score
            );
            filteredQuizzes.forEach(quiz => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="border p-2">${quiz.courseName}</td>
                    <td class="border p-2">${quiz.quizType}</td>
                    <td class="border p-2">
                        <button class="view-answer bg-blue-500 text-white px-2 py-1 rounded" data-quiz-id="${quiz.id}">View</button>
                    </td>
                `;
                tbody.appendChild(row);
                row.querySelector('.view-answer').addEventListener('click', () => {
                    currentQuiz = quizzes.find(q => q.id === quiz.id);
                    showStudentAnswers();
                });
            });
        }

        function showStudentAnswers() {
            document.getElementById('viewAnswersModal').style.display = 'none';
            document.getElementById('viewIndividualAnswerModal').style.display = 'flex';
            const answerDetails = document.getElementById('answerDetails');
            answerDetails.innerHTML = '';
            const student = students.find(s => s.id == currentQuiz.studentId);
            answerDetails.innerHTML += `<p><strong>Student:</strong> ${student.name}</p>`;
            answerDetails.innerHTML += `<p><strong>Course:</strong> ${currentQuiz.courseName}</p>`;
            answerDetails.innerHTML += `<p><strong>Quiz Type:</strong> ${currentQuiz.quizType}</p>`;
            currentQuiz.questions.forEach((q, i) => {
                const answer = currentQuiz.studentAnswers[i] || 'No answer provided';
                const answerText = Array.isArray(answer) ? answer.join(', ') : answer;
                const isOpen = q.type === 'open';
                const mark = currentQuiz.marks ? currentQuiz.marks[i] : null;
                const explanation = currentQuiz.explanations ? currentQuiz.explanations[i] : '';
                answerDetails.innerHTML += `
                    <div class="border p-2 mb-2 relative" id="question-${i}">
                        <p><strong>Question ${i + 1}:</strong> ${q.text}</p>
                        <p><strong>Answer:</strong> ${answerText}</p>
                        ${isOpen ? `
                            <div class="flex space-x-2 mt-2 marking-buttons-${i}">
                                <button class="mark-right bg-green-500 text-white px-2 py-1 rounded" data-question-index="${i}">✅</button>
                                <button class="mark-wrong bg-red-500 text-white px-2 py-1 rounded" data-question-index="${i}">❌</button>
                            </div>
                        ` : `
                            <p><strong>Auto-graded:</strong> ${mark === 'correct' ? 'Correct ✅' : 'Incorrect ❌'}</p>
                        `}
                        ${mark && isOpen ? `
                            <button class="edit-mark bg-gray-500 text-white px-2 py-1 rounded mt-2" data-question-index="${i}">Edit</button>
                            <span class="question-mark">${mark === 'correct' ? '✅' : '❌'}</span>
                        ` : ''}
                        ${isOpen ? `
                            <div id="wrong-explanation-${i}" class="mt-2 ${mark === 'wrong' ? '' : 'hidden'}">
                                <label class="block">Why it's wrong:</label>
                                <textarea class="border p-2 w-full" rows="3" placeholder="Explain why the answer is wrong">${explanation}</textarea>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            document.querySelectorAll('.mark-right').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = btn.dataset.questionIndex;
                    markQuestion(index, 'correct', '');
                });
            });
            document.querySelectorAll('.mark-wrong').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = btn.dataset.questionIndex;
                    const explanationDiv = document.getElementById(`wrong-explanation-${index}`);
                    if (explanationDiv) {
                        explanationDiv.classList.remove('hidden');
                    }
                    markQuestion(index, 'wrong', explanationDiv?.querySelector('textarea').value || '');
                });
            });
            document.querySelectorAll('.edit-mark').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = btn.dataset.questionIndex;
                    if (!currentQuiz.marks) currentQuiz.marks = [];
                    if (!currentQuiz.explanations) currentQuiz.explanations = [];
                    currentQuiz.marks[index] = null;
                    currentQuiz.explanations[index] = '';
                    showStudentAnswers(); // Refresh to show marking buttons
                });
            });
            document.getElementById('submitScoreBtn').addEventListener('click', () => {
                submitScore();
            });
        }

        function markQuestion(index, mark, explanation) {
            if (!currentQuiz.marks) currentQuiz.marks = [];
            if (!currentQuiz.explanations) currentQuiz.explanations = [];
            currentQuiz.marks[index] = mark;
            currentQuiz.explanations[index] = explanation;
            alert(`Question ${parseInt(index) + 1} marked as ${mark}.`);
            showStudentAnswers(); // Refresh to show mark icon and edit button
        }

        function submitScore() {
            if (!currentQuiz.marks || currentQuiz.marks.some((m, i) => m === null && currentQuiz.questions[i].type === 'open')) {
                alert('Please mark all open-ended questions before submitting the score.');
                return;
            }
            const correctCount = currentQuiz.marks.filter(m => m === 'correct').length;
            const totalQuestions = currentQuiz.questions.length;
            currentQuiz.score = `${correctCount}/${totalQuestions}`;
            delete savedQuizProgress[currentQuiz.id]; // Clear progress after scoring
            document.getElementById('viewIndividualAnswerModal').style.display = 'none';
            document.getElementById('viewAnswersModal').style.display = 'flex';
            updateQuizTable();
            updateStudentList();
            updateNotifications();
            alert(`Score submitted: ${currentQuiz.score}`);
        }

        document.getElementById('closeIndividualAnswerModalBtn').addEventListener('click', () => {
            document.getElementById('viewIndividualAnswerModal').style.display = 'none';
            document.getElementById('viewAnswersModal').style.display = 'flex';
        });

        // Close View Answers Modal
        document.getElementById('closeViewAnswersModalBtn').addEventListener('click', () => {
            document.getElementById('viewAnswersModal').style.display = 'none';
            selectedStudentId = null;
        });

        function startTimer() {
            let timeLeft = currentQuiz.quizTime * 60;
            document.getElementById('timerDisplay').textContent = formatTime(timeLeft);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').textContent = formatTime(timeLeft);
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitQuiz();
                }
            }, 1000);
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function showQuestion() {
            const question = currentQuiz.questions[currentQuestionIndex];
            const container = document.getElementById('currentQuestion');
            container.innerHTML = `
                <h3 class="font-bold mb-2">${currentQuestionIndex + 1}. ${question.text}</h3>
                <div class="choices"></div>
            `;
            if (question.type === 'trueFalse') {
                question.choices.forEach(choice => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label><input type="radio" name="answer" value="${choice}" 
                            ${studentAnswers[currentQuestionIndex] === choice ? 'checked' : ''}> ${choice}</label>
                    `;
                    container.querySelector('.choices').appendChild(div);
                });
            } else if (question.type === 'multipleChoice') {
                question.choices.forEach(choice => {
                    const div = document.createElement('div');
                    div.innerHTML = `
                        <label><input type="checkbox" name="answer" value="${choice}" 
                            ${studentAnswers[currentQuestionIndex]?.includes(choice) ? 'checked' : ''}> ${choice}</label>
                    `;
                    container.querySelector('.choices').appendChild(div);
                });
            } else if (question.type === 'open') {
                const div = document.createElement('div');
                div.innerHTML = `
                    <textarea class="border p-2 w-full" rows="4" placeholder="Enter your answer">${studentAnswers[currentQuestionIndex] || ''}</textarea>
                `;
                container.querySelector('.choices').appendChild(div);
            }
            document.getElementById('questionsLeft').textContent = 
                `Questions Left: ${currentQuiz.questions.length - currentQuestionIndex - 1}`;
            document.getElementById('prevQuestionBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextQuestionBtn').disabled = currentQuestionIndex === currentQuiz.questions.length - 1;
        }

        document.getElementById('prevQuestionBtn').addEventListener('click', () => {
            saveCurrentAnswer();
            currentQuestionIndex--;
            showQuestion();
        });

        document.getElementById('nextQuestionBtn').addEventListener('click', () => {
            saveCurrentAnswer();
            currentQuestionIndex++;
            showQuestion();
        });

        document.getElementById('cancelQuizBtn').addEventListener('click', () => {
            saveCurrentAnswer();
            savedQuizProgress[currentQuiz.id] = {
                currentQuestionIndex: currentQuestionIndex,
                studentAnswers: [...studentAnswers]
            };
            clearInterval(timerInterval);
            document.getElementById('takeQuizModal').style.display = 'none';
            document.getElementById('myQuizzesModal').style.display = 'flex';
        });

        function saveCurrentAnswer() {
            const question = currentQuiz.questions[currentQuestionIndex];
            if (question.type === 'trueFalse') {
                const selected = document.querySelector('input[name="answer"]:checked');
                studentAnswers[currentQuestionIndex] = selected ? selected.value : null;
            } else if (question.type === 'multipleChoice') {
                const selected = Array.from(document.querySelectorAll('input[name="answer"]:checked')).map(cb => cb.value);
                studentAnswers[currentQuestionIndex] = selected.length > 0 ? selected : null;
            } else if (question.type === 'open') {
                const textarea = document.querySelector('textarea');
                studentAnswers[currentQuestionIndex] = textarea ? textarea.value : null;
            }
        }

        document.getElementById('submitQuizBtn').addEventListener('click', () => {
            saveCurrentAnswer();
            document.getElementById('takeQuizModal').style.display = 'none';
            document.getElementById('submitQuizModal').style.display = 'flex';
        });

        document.getElementById('cancelSubmitBtn').addEventListener('click', () => {
            document.getElementById('submitQuizModal').style.display = 'none';
            document.getElementById('takeQuizModal').style.display = 'flex';
        });

        document.getElementById('confirmSubmitBtn').addEventListener('click', () => {
            document.getElementById('submitQuizModal').style.display = 'none';
            submitQuiz();
        });

        function submitQuiz() {
            clearInterval(timerInterval);
            currentQuiz.status = 'completed';
            currentQuiz.studentAnswers = studentAnswers;
            currentQuiz.marks = Array(currentQuiz.questions.length).fill(null);
            currentQuiz.explanations = Array(currentQuiz.questions.length).fill('');
            // Auto-mark true/false and multiple choice questions
            currentQuiz.questions.forEach((q, i) => {
                if (q.type === 'trueFalse' && studentAnswers[i]) {
                    currentQuiz.marks[i] = studentAnswers[i] === q.correctAnswers[0] ? 'correct' : 'wrong';
                } else if (q.type === 'multipleChoice' && studentAnswers[i]) {
                    const studentAnswer = studentAnswers[i].sort();
                    const correctAnswer = q.correctAnswers.sort();
                    currentQuiz.marks[i] = JSON.stringify(studentAnswer) === JSON.stringify(correctAnswer) ? 'correct' : 'wrong';
                }
            });
            delete savedQuizProgress[currentQuiz.id]; // Clear progress on submission
            document.getElementById('takeQuizModal').style.display = 'none';
            updateQuizTable();
            updateNotifications();
            updateStudentList();
            alert('Quiz submitted! Awaiting tutor grading for open-ended questions.');
        }
    </script>
</body>
</html>