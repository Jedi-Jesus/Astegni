<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Chat Modal</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        .log {
            background: #000;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #0f0;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            padding: 4px;
            border-bottom: 1px solid #333;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
        .warning { color: #ff0; }
        .info { color: #0ff; }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
        }
        button:hover {
            background: #0d0;
        }
    </style>
</head>
<body>
    <h1>üîç Chat Modal Debugger</h1>
    <p>This tool will help diagnose why the chat modal won't open.</p>

    <div>
        <button onclick="runDiagnostics()">üîç Run Full Diagnostics</button>
        <button onclick="tryOpenChat()">üí¨ Try Open Chat</button>
        <button onclick="clearLog()">üóëÔ∏è Clear Log</button>
        <button onclick="location.href='profile-pages/tutor-profile.html'">‚Üê Back to Tutor Profile</button>
    </div>

    <div class="log" id="logOutput"></div>

    <script>
        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('logOutput');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        };

        const clearLog = () => {
            document.getElementById('logOutput').innerHTML = '';
        };

        const runDiagnostics = () => {
            clearLog();
            log('========== STARTING DIAGNOSTICS ==========', 'info');

            // Check 1: ChatModalManager exists
            log('Check 1: ChatModalManager object', 'info');
            if (typeof ChatModalManager !== 'undefined') {
                log('‚úÖ ChatModalManager is defined', 'success');
            } else {
                log('‚ùå ChatModalManager is NOT defined', 'error');
                log('‚Üí Need to load chat-modal.js', 'warning');
            }

            // Check 2: openChatModal function
            log('Check 2: openChatModal function', 'info');
            if (typeof openChatModal === 'function') {
                log('‚úÖ openChatModal function exists', 'success');
            } else {
                log('‚ùå openChatModal function missing', 'error');
            }

            // Check 3: Modal HTML in DOM
            log('Check 3: Chat modal HTML in DOM', 'info');
            const modal = document.getElementById('chatModal');
            if (modal) {
                log('‚úÖ Chat modal HTML found in DOM', 'success');
                log(`‚Üí Modal classes: ${modal.className}`, 'info');
                log(`‚Üí Modal display: ${modal.style.display}`, 'info');
            } else {
                log('‚ùå Chat modal HTML NOT found in DOM', 'error');
                log('‚Üí Need to load chat-modal.html', 'warning');
            }

            // Check 4: Token/Authentication
            log('Check 4: Authentication token', 'info');
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');
            if (token) {
                log('‚úÖ Token found in localStorage', 'success');
                log(`‚Üí Token length: ${token.length} chars`, 'info');
            } else {
                log('‚ö†Ô∏è No token found - chat may not work', 'warning');
            }

            // Check 5: User data
            log('Check 5: User data in localStorage', 'info');
            const user = localStorage.getItem('user');
            if (user) {
                try {
                    const userData = JSON.parse(user);
                    log('‚úÖ User data found', 'success');
                    log(`‚Üí User ID: ${userData.id}`, 'info');
                    log(`‚Üí Email: ${userData.email}`, 'info');
                } catch (e) {
                    log('‚ö†Ô∏è User data exists but cannot parse', 'warning');
                }
            } else {
                log('‚ö†Ô∏è No user data in localStorage', 'warning');
            }

            // Check 6: ChatModalManager state
            if (typeof ChatModalManager !== 'undefined') {
                log('Check 6: ChatModalManager state', 'info');
                if (ChatModalManager.state) {
                    log('‚úÖ ChatModalManager.state exists', 'success');
                    log(`‚Üí isOpen: ${ChatModalManager.state.isOpen}`, 'info');
                    log(`‚Üí currentUser: ${ChatModalManager.state.currentUser ? 'loaded' : 'not loaded'}`,
                        ChatModalManager.state.currentUser ? 'success' : 'warning');
                    if (ChatModalManager.state.currentUser) {
                        log(`‚Üí User ID: ${ChatModalManager.state.currentUser.user_id}`, 'info');
                        log(`‚Üí Name: ${ChatModalManager.state.currentUser.name}`, 'info');
                    }
                } else {
                    log('‚ùå ChatModalManager.state is undefined', 'error');
                }
            }

            // Check 7: Try to load modal if missing
            if (!document.getElementById('chatModal')) {
                log('Check 7: Attempting to load modal HTML...', 'info');
                fetch('modals/common-modals/chat-modal.html')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        return response.text();
                    })
                    .then(html => {
                        document.body.insertAdjacentHTML('beforeend', html);
                        log('‚úÖ Chat modal HTML loaded successfully!', 'success');
                        log('‚Üí Now try clicking "Try Open Chat" button', 'info');
                    })
                    .catch(err => {
                        log(`‚ùå Failed to load chat modal HTML: ${err.message}`, 'error');
                        log('‚Üí Check if file exists at modals/common-modals/chat-modal.html', 'warning');
                    });
            }

            log('========== DIAGNOSTICS COMPLETE ==========', 'info');
        };

        const tryOpenChat = () => {
            log('========== ATTEMPTING TO OPEN CHAT ==========', 'info');

            // Check if ChatModalManager exists
            if (typeof ChatModalManager === 'undefined') {
                log('‚ùå ChatModalManager not defined, loading script...', 'warning');
                const script = document.createElement('script');
                script.src = 'js/common-modals/chat-modal.js';
                script.onload = () => {
                    log('‚úÖ chat-modal.js loaded', 'success');
                    setTimeout(() => {
                        tryActualOpen();
                    }, 500);
                };
                script.onerror = () => {
                    log('‚ùå Failed to load chat-modal.js', 'error');
                };
                document.head.appendChild(script);
                return;
            }

            tryActualOpen();
        };

        const tryActualOpen = () => {
            if (typeof openChatModal === 'function') {
                log('‚Üí Calling openChatModal()...', 'info');
                try {
                    openChatModal();
                    log('‚úÖ openChatModal() called successfully', 'success');
                    setTimeout(() => {
                        const modal = document.getElementById('chatModal');
                        if (modal && modal.style.display !== 'none' && !modal.classList.contains('hidden')) {
                            log('‚úÖ Chat modal is now visible!', 'success');
                        } else {
                            log('‚ö†Ô∏è openChatModal() executed but modal not visible', 'warning');
                            log('‚Üí Check console for errors', 'info');
                        }
                    }, 1000);
                } catch (error) {
                    log(`‚ùå Error calling openChatModal(): ${error.message}`, 'error');
                    console.error(error);
                }
            } else if (typeof ChatModalManager !== 'undefined') {
                log('‚Üí Calling ChatModalManager.open()...', 'info');
                try {
                    ChatModalManager.open();
                    log('‚úÖ ChatModalManager.open() called successfully', 'success');
                } catch (error) {
                    log(`‚ùå Error calling ChatModalManager.open(): ${error.message}`, 'error');
                    console.error(error);
                }
            } else {
                log('‚ùå No chat opening method available', 'error');
            }
        };

        // Auto-run diagnostics on page load
        window.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Chat Modal Debugger Ready', 'success');
            log('Click "Run Full Diagnostics" to check system status', 'info');
        });
    </script>
</body>
</html>
