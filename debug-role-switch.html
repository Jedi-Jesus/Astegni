<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Role Switch Debug Tool</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .section {
            background: #252526;
            border: 1px solid #3e3e42;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        h2 {
            color: #4ec9b0;
            margin-top: 0;
        }
        .key {
            color: #9cdcfe;
            font-weight: bold;
        }
        .value {
            color: #ce9178;
        }
        .null {
            color: #808080;
            font-style: italic;
        }
        .warning {
            color: #ff6b6b;
        }
        .success {
            color: #51cf66;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        button:hover {
            background: #1177bb;
        }
        .refresh-btn {
            background: #16825d;
        }
        .clear-btn {
            background: #d13438;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Role Switch Debug Tool</h1>

    <button onclick="refreshData()" class="refresh-btn">üîÑ Refresh Data</button>
    <button onclick="clearRoleSwitchFlags()" class="clear-btn">üóëÔ∏è Clear Role Switch Flags</button>
    <button onclick="clearAllAuth()" class="clear-btn">‚ö†Ô∏è Clear All Auth Data</button>

    <div class="section">
        <h2>üìä Current State</h2>
        <div id="current-state"></div>
    </div>

    <div class="section">
        <h2>üîê Auth State (from AuthManager)</h2>
        <div id="auth-state"></div>
    </div>

    <div class="section">
        <h2>‚è±Ô∏è Role Switch Grace Period</h2>
        <div id="grace-period"></div>
    </div>

    <div class="section">
        <h2>üíæ LocalStorage Dump</h2>
        <pre id="localstorage-dump"></pre>
    </div>

    <div class="section">
        <h2>üß™ Test Actions</h2>
        <button onclick="simulateRoleSwitch('tutor')">Switch to Tutor</button>
        <button onclick="simulateRoleSwitch('student')">Switch to Student</button>
        <button onclick="simulateRoleSwitch('parent')">Switch to Parent</button>
        <div id="test-output" style="margin-top: 10px;"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000';

        function refreshData() {
            displayCurrentState();
            displayAuthState();
            displayGracePeriod();
            displayLocalStorageDump();
        }

        function displayCurrentState() {
            const container = document.getElementById('current-state');
            const userRole = localStorage.getItem('userRole');
            const currentUser = localStorage.getItem('currentUser');
            const token = localStorage.getItem('token') || localStorage.getItem('access_token');

            let html = '';
            html += `<div><span class="key">localStorage.userRole:</span> <span class="${userRole ? 'value' : 'null'}">${userRole || 'null'}</span></div>`;
            html += `<div><span class="key">Has token:</span> <span class="${token ? 'success' : 'null'}">${!!token}</span></div>`;

            if (currentUser) {
                try {
                    const user = JSON.parse(currentUser);
                    html += `<div><span class="key">currentUser.active_role:</span> <span class="value">${user.active_role || 'null'}</span></div>`;
                    html += `<div><span class="key">currentUser.role:</span> <span class="value">${user.role || 'null'}</span></div>`;
                    html += `<div><span class="key">currentUser.roles:</span> <span class="value">${JSON.stringify(user.roles)}</span></div>`;
                } catch (e) {
                    html += `<div class="warning">Error parsing currentUser: ${e.message}</div>`;
                }
            } else {
                html += `<div><span class="key">currentUser:</span> <span class="null">null</span></div>`;
            }

            container.innerHTML = html;
        }

        function displayAuthState() {
            const container = document.getElementById('auth-state');
            let html = '';

            if (typeof window.AuthManager !== 'undefined') {
                const user = window.AuthManager.getUser();
                const role = window.AuthManager.getUserRole();
                const isAuth = window.AuthManager.isAuthenticated();

                html += `<div><span class="key">isAuthenticated():</span> <span class="${isAuth ? 'success' : 'null'}">${isAuth}</span></div>`;
                html += `<div><span class="key">getUserRole():</span> <span class="value">${role || 'null'}</span></div>`;

                if (user) {
                    html += `<div><span class="key">user.active_role:</span> <span class="value">${user.active_role || 'null'}</span></div>`;
                    html += `<div><span class="key">user.role:</span> <span class="value">${user.role || 'null'}</span></div>`;
                    html += `<div><span class="key">user.roles:</span> <span class="value">${JSON.stringify(user.roles)}</span></div>`;
                } else {
                    html += `<div><span class="key">user:</span> <span class="null">null</span></div>`;
                }
            } else {
                html += `<div class="warning">AuthManager not loaded</div>`;
            }

            container.innerHTML = html;
        }

        function displayGracePeriod() {
            const container = document.getElementById('grace-period');
            const switchTimestamp = localStorage.getItem('role_switch_timestamp');
            const targetRole = localStorage.getItem('role_switch_target');

            let html = '';

            if (switchTimestamp) {
                const timeSinceSwitch = Date.now() - parseInt(switchTimestamp);
                const isValid = timeSinceSwitch < 5000;
                const timeRemaining = Math.max(0, 5000 - timeSinceSwitch);

                html += `<div><span class="key">Timestamp:</span> <span class="value">${switchTimestamp}</span></div>`;
                html += `<div><span class="key">Target Role:</span> <span class="value">${targetRole || 'null'}</span></div>`;
                html += `<div><span class="key">Time Since Switch:</span> <span class="${isValid ? 'success' : 'warning'}">${timeSinceSwitch}ms</span></div>`;
                html += `<div><span class="key">Grace Period Valid:</span> <span class="${isValid ? 'success' : 'warning'}">${isValid}</span></div>`;
                html += `<div><span class="key">Time Remaining:</span> <span class="${isValid ? 'success' : 'null'}">${timeRemaining}ms</span></div>`;
            } else {
                html += `<div class="null">No active role switch in progress</div>`;
            }

            container.innerHTML = html;
        }

        function displayLocalStorageDump() {
            const container = document.getElementById('localstorage-dump');
            const dump = {};

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                dump[key] = localStorage.getItem(key);
            }

            container.textContent = JSON.stringify(dump, null, 2);
        }

        function clearRoleSwitchFlags() {
            localStorage.removeItem('role_switch_timestamp');
            localStorage.removeItem('role_switch_target');
            alert('Cleared role switch flags');
            refreshData();
        }

        function clearAllAuth() {
            if (confirm('This will log you out. Continue?')) {
                localStorage.clear();
                alert('Cleared all localStorage');
                refreshData();
            }
        }

        async function simulateRoleSwitch(targetRole) {
            const output = document.getElementById('test-output');
            output.innerHTML = `<div class="success">Simulating switch to ${targetRole}...</div>`;

            // Set the flags
            const timestamp = Date.now();
            localStorage.setItem('role_switch_timestamp', timestamp.toString());
            localStorage.setItem('role_switch_target', targetRole);
            localStorage.setItem('userRole', targetRole);

            output.innerHTML += `<div class="success">‚úÖ Flags set! Timestamp: ${timestamp}</div>`;
            output.innerHTML += `<div>Navigate to profile-pages/${targetRole}-profile.html to test</div>`;

            refreshData();
        }

        // Auto-refresh every 1 second
        setInterval(refreshData, 1000);

        // Initial load
        refreshData();
    </script>

    <!-- Load AuthManager if available -->
    <script>
        // Try to load AuthManager for testing
        const script = document.createElement('script');
        script.src = '../js/root/auth.js';
        script.onerror = () => {
            console.log('Could not load AuthManager (expected if not in correct path)');
        };
        document.head.appendChild(script);
    </script>
</body>
</html>
