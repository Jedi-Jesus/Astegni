<!-- Add Child Modal -->
<div id="addChildModal" class="modal hidden">
    <div class="modal-overlay" onclick="closeAddChildModal()"></div>
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; display: flex; flex-direction: column;">

        <!-- Step 1: Search for existing user or create new -->
        <div id="add-child-step-1" class="add-child-step" style="display: flex; flex-direction: column; height: 100%; max-height: 85vh;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>+</span> Add Child
                </h2>
                <button class="modal-close" onclick="closeAddChildModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem; overflow-y: auto; flex: 1;">
                <p class="text-gray-600 dark:text-gray-400 mb-4">Search for your child in our system or create a new student account for them.</p>

                <!-- Search Bar -->
                <div class="relative mb-4">
                    <input type="text"
                           id="child-search-input"
                           placeholder="Search by name, email, or phone..."
                           class="w-full px-4 py-3 pl-12 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 placeholder-gray-400 focus:border-purple-500 focus:outline-none transition-all"
                           oninput="ChildInvitationManager.searchUsers(this.value)">
                    <svg class="w-5 h-5 absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <div id="child-search-loading" class="absolute right-4 top-1/2 transform -translate-y-1/2 hidden">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-purple-500"></div>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="child-search-results" class="space-y-3 max-h-64 overflow-y-auto mb-4">
                    <div class="text-center py-8 text-gray-400">
                        <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <p>Start typing to search for your child</p>
                    </div>
                </div>

                <!-- Divider -->
                <div class="flex items-center gap-4 my-6">
                    <div class="flex-1 border-t border-gray-200 dark:border-gray-600"></div>
                    <span class="text-gray-400 text-sm font-medium">OR</span>
                    <div class="flex-1 border-t border-gray-200 dark:border-gray-600"></div>
                </div>

                <!-- Add New Child Button -->
                <button onclick="ChildInvitationManager.showAddNewChildForm()"
                        class="w-full py-4 px-6 rounded-xl border-2 border-dashed border-purple-300 dark:border-purple-600 bg-purple-50 dark:bg-purple-900/20 hover:bg-purple-100 dark:hover:bg-purple-900/30 transition-all flex items-center justify-center gap-3 text-purple-600 dark:text-purple-400 font-semibold">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                    </svg>
                    Create New Student Account
                </button>
            </div>
        </div>

        <!-- Step 2: Link Existing User - Security Verification with DOB -->
        <div id="add-child-step-2" class="add-child-step hidden" style="display: none; flex-direction: column; height: 100%; max-height: 85vh;">
            <div class="modal-header" style="flex-shrink: 0;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <button onclick="ChildInvitationManager.backToSearch()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </button>
                    <h2>Verify & Send Invitation</h2>
                </div>
                <button class="modal-close" onclick="closeAddChildModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem; overflow-y: auto; flex: 1;">
                <!-- Selected User Card -->
                <div id="selected-child-card" class="p-4 rounded-xl bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border border-green-200 dark:border-green-700/50 mb-6">
                    <!-- Will be populated dynamically -->
                </div>

                <form id="linkExistingChildForm" onsubmit="ChildInvitationManager.submitInviteExistingChild(event)">
                    <input type="hidden" id="selected-child-user-id" value="">

                    <!-- Security Verification with Date of Birth -->
                    <div class="p-4 rounded-xl bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700/50 mb-4">
                        <h4 class="font-semibold text-amber-700 dark:text-amber-400 mb-3 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            Security Verification
                        </h4>
                        <p class="text-sm text-amber-600 dark:text-amber-500 mb-3">To verify your relationship, please enter your child's date of birth.</p>
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Child's Date of Birth *</label>
                            <input type="date" id="verify-child-dob" required
                                   class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:border-amber-500 focus:outline-none transition-all">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">This must match the date of birth in your child's account.</p>
                        </div>
                    </div>

                    <div class="p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700/50 mb-4">
                        <p class="text-sm text-blue-700 dark:text-blue-400">
                            <strong>Note:</strong> An invitation will be sent to this user. They will need to accept it to be linked as your child.
                        </p>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="ChildInvitationManager.backToSearch()"
                                class="flex-1 py-3 px-4 rounded-xl border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                            Back
                        </button>
                        <button type="submit" id="send-invitation-btn"
                                class="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold hover:from-green-600 hover:to-emerald-600 transition-all shadow-lg flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            Send Invitation
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Step 3: Add New Child Form -->
        <div id="add-child-step-3" class="add-child-step hidden" style="display: none; flex-direction: column; height: 100%; max-height: 85vh;">
            <div class="modal-header" style="flex-shrink: 0;">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <button onclick="ChildInvitationManager.backToSearch()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </button>
                    <h2>Create Student Account</h2>
                </div>
                <button class="modal-close" onclick="closeAddChildModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem; overflow-y: auto; flex: 1;">
                <p class="text-gray-500 dark:text-gray-400 mb-4 text-sm">Create a student account for your child. They will receive a temporary password via email/SMS to log in.</p>

                <form id="addNewChildForm" onsubmit="ChildInvitationManager.submitNewChild(event)">
                    <!-- Child Information -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="form-group">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">First Name *</label>
                            <input type="text" id="new-child-first-name" required
                                   placeholder="Child's first name"
                                   class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:border-purple-500 focus:outline-none transition-all">
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Father's Name *</label>
                            <input type="text" id="new-child-father-name" required
                                   placeholder="Child's father name"
                                   class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:border-purple-500 focus:outline-none transition-all">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="form-group">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Grandfather's Name *</label>
                            <input type="text" id="new-child-grandfather-name" required
                                   placeholder="Child's grandfather name"
                                   class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:border-purple-500 focus:outline-none transition-all">
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Gender</label>
                            <select id="new-child-gender"
                                    class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:border-purple-500 focus:outline-none transition-all">
                                <option value="">Select gender...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="form-group">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Email</label>
                            <input type="email" id="new-child-email"
                                   placeholder="child@email.com"
                                   class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:border-purple-500 focus:outline-none transition-all">
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Phone</label>
                            <input type="tel" id="new-child-phone"
                                   placeholder="+251 9XX XXX XXX"
                                   class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:border-purple-500 focus:outline-none transition-all">
                        </div>
                    </div>

                    <div class="form-group mb-4">
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Date of Birth</label>
                        <input type="date" id="new-child-dob"
                               class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:border-purple-500 focus:outline-none transition-all">
                    </div>

                    <div class="p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-700/50 mb-4">
                        <p class="text-sm text-blue-700 dark:text-blue-400">
                            <strong>Note:</strong> A temporary password will be sent to the email/phone provided. Your child will use it to log in and the account will be automatically linked to you.
                        </p>
                    </div>

                    <div class="flex gap-3 mt-6">
                        <button type="button" onclick="ChildInvitationManager.backToSearch()"
                                class="flex-1 py-3 px-4 rounded-xl border-2 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-semibold hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                            Back
                        </button>
                        <button type="submit" id="create-child-btn"
                                class="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-blue-500 to-purple-500 text-white font-semibold hover:from-blue-600 hover:to-purple-600 transition-all shadow-lg flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                            </svg>
                            Create Account
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Step 4: Success -->
        <div id="add-child-step-4" class="add-child-step hidden" style="display: none; flex-direction: column; height: 100%; max-height: 85vh;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2 style="display: flex; align-items: center; gap: 0.5rem;">
                    <span>+</span> Success!
                </h2>
                <button class="modal-close" onclick="closeAddChildModal()">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.5rem; overflow-y: auto; flex: 1; text-align: center;">
                <div class="mb-6">
                    <div style="font-size: 4rem; margin-bottom: 1rem;" id="success-icon">&#127881;</div>
                    <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2" id="success-title">Success!</h3>
                    <p class="text-gray-600 dark:text-gray-400" id="success-message">Action completed successfully.</p>
                </div>

                <!-- Temporary Password Display (for new users - DEV ONLY) -->
                <div id="temp-password-container" class="p-4 rounded-xl bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700/50 mb-6 hidden">
                    <h4 class="font-semibold text-amber-700 dark:text-amber-400 mb-2 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                        </svg>
                        Temporary Password (Dev Only)
                    </h4>
                    <p class="text-sm text-amber-600 dark:text-amber-500 mb-3">Share this password with your child so they can log in:</p>
                    <div class="flex items-center justify-center gap-2">
                        <code id="temp-password-display" class="px-4 py-2 bg-white dark:bg-gray-800 rounded-lg text-lg font-mono font-bold text-gray-800 dark:text-gray-200 border border-gray-200 dark:border-gray-600">
                            xxxxxx
                        </code>
                        <button onclick="ChildInvitationManager.copyTempPassword()" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors" title="Copy password">
                            <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Invitation Sent Info (for existing users) -->
                <div id="invitation-sent-container" class="p-3 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700/50 mb-6 hidden">
                    <p class="text-sm text-green-700 dark:text-green-400">
                        <strong>Next:</strong> Your child will receive a notification about your invitation. Once they accept, they will be linked to your account.
                    </p>
                </div>

                <button onclick="closeAddChildModal(); if(typeof ChildrenManager !== 'undefined') ChildrenManager.loadChildren();"
                        class="w-full py-3 px-4 rounded-xl bg-gradient-to-r from-blue-500 to-purple-500 text-white font-semibold hover:from-blue-600 hover:to-purple-600 transition-all shadow-lg">
                    Done
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================
// CHILD INVITATION MANAGER
// Handles the add-child modal with invitation flow
// Security: Uses DOB verification for existing users
// ============================================

const ChildInvitationManager = {
    selectedUser: null,
    tempPassword: null,
    searchTimeout: null,

    /**
     * Search for users by name, email, or phone
     */
    async searchUsers(query) {
        const resultsContainer = document.getElementById('child-search-results');
        const loadingIndicator = document.getElementById('child-search-loading');

        if (!query || query.length < 2) {
            resultsContainer.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <p>Start typing to search for your child</p>
                </div>
            `;
            return;
        }

        // Debounce search
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(async () => {
            loadingIndicator?.classList.remove('hidden');

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/users/search?q=${encodeURIComponent(query)}&limit=10`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Search failed');

                const users = await response.json();

                if (users.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="text-center py-6 text-gray-400">
                            <p>No users found matching "${query}"</p>
                            <p class="text-sm mt-2">Try a different search or create a new account</p>
                        </div>
                    `;
                } else {
                    resultsContainer.innerHTML = users.map(user => this.createUserCard(user)).join('');
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = `
                    <div class="text-center py-6 text-gray-400">
                        <p>Search failed. Please try again.</p>
                    </div>
                `;
            } finally {
                loadingIndicator?.classList.add('hidden');
            }
        }, 300);
    },

    /**
     * Create a user card for search results
     */
    createUserCard(user) {
        const name = `${user.first_name || ''} ${user.father_name || ''}`.trim() || 'Unknown';
        const avatar = user.profile_picture || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=10B981&color=fff&size=64`;
        const roles = user.roles || [];
        const rolesDisplay = roles.length > 0 ? roles.join(', ') : 'No roles';

        return `
            <div onclick="ChildInvitationManager.selectUser(${JSON.stringify(user).replace(/"/g, '&quot;')})"
                 class="flex items-center gap-4 p-4 rounded-xl border-2 border-gray-200 dark:border-gray-600 hover:border-green-400 dark:hover:border-green-500 bg-white dark:bg-gray-700 cursor-pointer transition-all">
                <img src="${avatar}" alt="${name}" class="w-12 h-12 rounded-full object-cover border-2 border-green-200">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-800 dark:text-gray-200">${name}</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">${rolesDisplay}</p>
                </div>
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </div>
        `;
    },

    /**
     * Select a user from search results
     */
    selectUser(user) {
        this.selectedUser = user;
        document.getElementById('selected-child-user-id').value = user.user_id;

        const name = `${user.first_name || ''} ${user.father_name || ''}`.trim() || 'Unknown';
        const avatar = user.profile_picture || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=10B981&color=fff&size=64`;
        const roles = user.roles || [];
        const rolesDisplay = roles.length > 0 ? roles.join(', ') : 'No roles';

        document.getElementById('selected-child-card').innerHTML = `
            <div class="flex items-center gap-4">
                <img src="${avatar}" alt="${name}" class="w-16 h-16 rounded-full object-cover border-3 border-green-400">
                <div>
                    <h4 class="font-bold text-lg text-gray-800 dark:text-gray-200">${name}</h4>
                    <p class="text-gray-500 dark:text-gray-400">${rolesDisplay}</p>
                    ${user.email ? `<p class="text-sm text-gray-400">${user.email}</p>` : ''}
                </div>
            </div>
        `;

        // Show step 2
        this.showStep(2);
    },

    /**
     * Show add new child form
     */
    showAddNewChildForm() {
        this.showStep(3);
    },

    /**
     * Back to search
     */
    backToSearch() {
        this.selectedUser = null;
        this.showStep(1);
    },

    /**
     * Show specific step
     */
    showStep(stepNumber) {
        // Hide all steps
        document.querySelectorAll('.add-child-step').forEach(step => {
            step.classList.add('hidden');
            step.style.display = 'none';
        });

        // Show target step
        const targetStep = document.getElementById(`add-child-step-${stepNumber}`);
        if (targetStep) {
            targetStep.classList.remove('hidden');
            targetStep.style.display = 'flex';
        }
    },

    /**
     * Submit invitation to existing user
     */
    async submitInviteExistingChild(event) {
        event.preventDefault();

        const userId = document.getElementById('selected-child-user-id').value;
        const dob = document.getElementById('verify-child-dob').value;

        if (!userId || !dob) {
            showNotification('Please fill in all required fields', 'error');
            return;
        }

        const btn = document.getElementById('send-invitation-btn');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div> Sending...';

        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/api/parent/invite-child`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    target_user_id: parseInt(userId),
                    security_dob: dob
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.detail || 'Failed to send invitation');
            }

            // Show success
            document.getElementById('success-icon').innerHTML = '&#9993;';
            document.getElementById('success-title').textContent = 'Invitation Sent!';
            document.getElementById('success-message').textContent = `Your child will receive a notification to accept your invitation.`;
            document.getElementById('temp-password-container').classList.add('hidden');
            document.getElementById('invitation-sent-container').classList.remove('hidden');

            this.showStep(4);

        } catch (error) {
            console.error('Invitation error:', error);
            showNotification(error.message || 'Failed to send invitation', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }
    },

    /**
     * Submit new child form
     */
    async submitNewChild(event) {
        event.preventDefault();

        const firstName = document.getElementById('new-child-first-name').value;
        const fatherName = document.getElementById('new-child-father-name').value;
        const grandfatherName = document.getElementById('new-child-grandfather-name').value;
        const gender = document.getElementById('new-child-gender').value;
        const email = document.getElementById('new-child-email').value;
        const phone = document.getElementById('new-child-phone').value;
        const dob = document.getElementById('new-child-dob').value;

        if (!firstName || !fatherName || !grandfatherName) {
            showNotification('Please fill in all required name fields', 'error');
            return;
        }

        if (!email && !phone) {
            showNotification('Please provide either email or phone', 'error');
            return;
        }

        const btn = document.getElementById('create-child-btn');
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div> Creating...';

        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/api/parent/invite-new-child`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    first_name: firstName,
                    father_name: fatherName,
                    grandfather_name: grandfatherName,
                    gender: gender || null,
                    email: email || null,
                    phone: phone || null,
                    date_of_birth: dob || null
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.detail || 'Failed to create child account');
            }

            // Show success with temp password
            this.tempPassword = data.temp_password;
            document.getElementById('success-icon').innerHTML = '&#127881;';
            document.getElementById('success-title').textContent = `${firstName}'s Account Created!`;
            document.getElementById('success-message').textContent = 'Your child can now log in with the temporary password.';
            document.getElementById('invitation-sent-container').classList.add('hidden');

            if (data.temp_password) {
                document.getElementById('temp-password-display').textContent = data.temp_password;
                document.getElementById('temp-password-container').classList.remove('hidden');
            } else {
                document.getElementById('temp-password-container').classList.add('hidden');
            }

            this.showStep(4);

        } catch (error) {
            console.error('Create child error:', error);
            showNotification(error.message || 'Failed to create child account', 'error');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalContent;
        }
    },

    /**
     * Copy temporary password to clipboard
     */
    copyTempPassword() {
        if (this.tempPassword) {
            navigator.clipboard.writeText(this.tempPassword).then(() => {
                showNotification('Password copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy password', 'error');
            });
        }
    },

    /**
     * Reset modal state
     */
    reset() {
        this.selectedUser = null;
        this.tempPassword = null;

        // Reset forms
        const searchInput = document.getElementById('child-search-input');
        if (searchInput) searchInput.value = '';

        const linkForm = document.getElementById('linkExistingChildForm');
        if (linkForm) linkForm.reset();

        const newForm = document.getElementById('addNewChildForm');
        if (newForm) newForm.reset();

        // Reset search results
        const resultsContainer = document.getElementById('child-search-results');
        if (resultsContainer) {
            resultsContainer.innerHTML = `
                <div class="text-center py-8 text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <p>Start typing to search for your child</p>
                </div>
            `;
        }

        // Hide containers
        const tempContainer = document.getElementById('temp-password-container');
        if (tempContainer) tempContainer.classList.add('hidden');

        const invContainer = document.getElementById('invitation-sent-container');
        if (invContainer) invContainer.classList.add('hidden');

        // Show step 1
        this.showStep(1);
    }
};

// Make available globally
window.ChildInvitationManager = ChildInvitationManager;

// Keep old manager name for backwards compatibility
window.ChildrenModalManager = ChildInvitationManager;

// ============================================
// MODAL OPEN/CLOSE FUNCTIONS
// ============================================

function openAddChildModal() {
    const modal = document.getElementById('addChildModal');
    if (modal) {
        ChildInvitationManager.reset();
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    } else {
        console.error('Add Child Modal not found! Loading...');
        loadAddChildModal().then(() => openAddChildModal());
    }
}

function closeAddChildModal() {
    const modal = document.getElementById('addChildModal');
    if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
        document.body.style.overflow = '';
        ChildInvitationManager.reset();
    }
}

// Async modal loader
async function loadAddChildModal() {
    try {
        const response = await fetch('../modals/parent-profile/add-child-modal.html');
        if (!response.ok) throw new Error('Failed to load modal');

        const html = await response.text();
        let container = document.getElementById('modal-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'modal-container';
            document.body.appendChild(container);
        }

        if (!document.getElementById('addChildModal')) {
            container.insertAdjacentHTML('beforeend', html);
        }

        console.log('Add Child Modal loaded successfully');
    } catch (error) {
        console.error('Failed to load Add Child Modal:', error);
    }
}

// Make functions available globally
window.openAddChildModal = openAddChildModal;
window.closeAddChildModal = closeAddChildModal;
window.loadAddChildModal = loadAddChildModal;

console.log('Add Child Modal with Invitation Flow loaded');
</script>
