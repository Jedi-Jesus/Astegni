<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Parent Invitations - Astegni</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-entry { font-family: 'Courier New', monospace; font-size: 12px; padding: 4px 8px; border-left: 3px solid #ccc; margin: 2px 0; }
        .log-info { border-color: #3b82f6; background: #eff6ff; }
        .log-success { border-color: #10b981; background: #d1fae5; }
        .log-error { border-color: #ef4444; background: #fee2e2; }
        .log-warning { border-color: #f59e0b; background: #fef3c7; }
        pre { background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 6px; overflow-x: auto; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">üîç Parent Invitations Debug Tool</h1>

        <!-- Controls -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Controls</h2>
            <div class="flex gap-4">
                <button onclick="testPendingInvitations()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg font-medium">
                    Test GET /api/parent/pending-invitations
                </button>
                <button onclick="testStudentInvitations()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium">
                    Test GET /api/student/parent-invitations
                </button>
                <button onclick="checkAuth()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-2 rounded-lg font-medium">
                    Check Authentication
                </button>
                <button onclick="clearLogs()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                    Clear Logs
                </button>
            </div>
        </div>

        <!-- Auth Status -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">üîê Authentication Status</h2>
            <div id="auth-status" class="space-y-2"></div>
        </div>

        <!-- Console Logs -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">üìã Console Logs</h2>
            <div id="console-logs" class="space-y-1 max-h-96 overflow-y-auto"></div>
        </div>

        <!-- API Response -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">üì° Latest API Response</h2>
            <div id="api-response"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.API_BASE_URL || 'http://localhost:8000';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('console-logs');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function clearLogs() {
            document.getElementById('console-logs').innerHTML = '';
            document.getElementById('api-response').innerHTML = '';
            log('Logs cleared', 'info');
        }

        function getToken() {
            return localStorage.getItem('token') || localStorage.getItem('access_token');
        }

        async function checkAuth() {
            log('Checking authentication...', 'info');

            const token = getToken();
            const authDiv = document.getElementById('auth-status');

            if (!token) {
                authDiv.innerHTML = '<div class="text-red-600 font-semibold">‚ùå No token found in localStorage</div>';
                log('No token found!', 'error');
                return;
            }

            log(`Token found: ${token.substring(0, 30)}...`, 'success');

            // Decode JWT (simple base64 decode)
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                authDiv.innerHTML = `
                    <div class="text-green-600 font-semibold">‚úÖ Token found</div>
                    <div class="mt-2 text-sm">
                        <strong>User ID:</strong> ${payload.sub || 'N/A'}<br>
                        <strong>Role:</strong> ${payload.role || 'N/A'}<br>
                        <strong>Role IDs:</strong> ${JSON.stringify(payload.role_ids || {})}<br>
                        <strong>Expires:</strong> ${new Date(payload.exp * 1000).toLocaleString()}
                    </div>
                `;
                log(`User ID: ${payload.sub}, Role: ${payload.role}`, 'info');
                log(`Role IDs: ${JSON.stringify(payload.role_ids)}`, 'info');
            } catch (e) {
                authDiv.innerHTML = '<div class="text-yellow-600">‚ö†Ô∏è Token found but could not decode</div>';
                log(`Could not decode token: ${e.message}`, 'warning');
            }
        }

        async function testPendingInvitations() {
            log('Testing GET /api/parent/pending-invitations...', 'info');

            const token = getToken();
            if (!token) {
                log('ERROR: No token found!', 'error');
                alert('Please log in first!');
                return;
            }

            const url = `${API_BASE_URL}/api/parent/pending-invitations`;
            log(`Making request to: ${url}`, 'info');

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`Response status: ${response.status} ${response.statusText}`,
                    response.ok ? 'success' : 'error');

                const data = await response.json();

                log(`Response received - ${data.invitations?.length || 0} invitations`, 'success');

                document.getElementById('api-response').innerHTML = `
                    <div class="mb-4">
                        <span class="font-semibold">Status:</span>
                        <span class="${response.ok ? 'text-green-600' : 'text-red-600'}">${response.status} ${response.statusText}</span>
                    </div>
                    <div class="mb-4">
                        <span class="font-semibold">Invitations Count:</span> ${data.invitations?.length || 0}
                    </div>
                    <div>
                        <span class="font-semibold">Full Response:</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;

                if (data.invitations && data.invitations.length > 0) {
                    data.invitations.forEach((inv, idx) => {
                        log(`Invitation ${idx + 1}: ID=${inv.id}, Student=${inv.student_name}, Relationship=${inv.relationship_type}`, 'info');
                    });
                } else {
                    log('‚ö†Ô∏è No invitations returned', 'warning');
                }

            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
                document.getElementById('api-response').innerHTML = `
                    <div class="text-red-600">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function testStudentInvitations() {
            log('Testing GET /api/student/parent-invitations...', 'info');

            const token = getToken();
            if (!token) {
                log('ERROR: No token found!', 'error');
                alert('Please log in first!');
                return;
            }

            const url = `${API_BASE_URL}/api/student/parent-invitations`;
            log(`Making request to: ${url}`, 'info');

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                log(`Response status: ${response.status} ${response.statusText}`,
                    response.ok ? 'success' : 'error');

                const data = await response.json();

                log(`Response received - ${data.invitations?.length || 0} invitations`, 'success');

                document.getElementById('api-response').innerHTML = `
                    <div class="mb-4">
                        <span class="font-semibold">Status:</span>
                        <span class="${response.ok ? 'text-green-600' : 'text-red-600'}">${response.status} ${response.statusText}</span>
                    </div>
                    <div class="mb-4">
                        <span class="font-semibold">Invitations Count:</span> ${data.invitations?.length || 0}
                    </div>
                    <div>
                        <span class="font-semibold">Full Response:</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;

            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
                document.getElementById('api-response').innerHTML = `
                    <div class="text-red-600">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Auto-check auth on page load
        window.addEventListener('DOMContentLoaded', () => {
            log('Debug page loaded', 'success');
            checkAuth();
        });
    </script>
</body>
</html>
